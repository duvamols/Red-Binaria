<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Así va tu red | Red de Acción Masiva</title>

  <link rel="preconnect" href="https://fonts.gstatic.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --primary:#2563eb;
      --accent:#22c55e;
      --bg:#f1f5f9;
      --surface:#ffffff;
      --text:#0f172a;
      --chip-bg:#e0f2fe;
      --chip-color:#2563eb;
      --radius:18px;

      --node:92px;  /* tamaño base del nodo */
      --gap:24px;   /* espacio horizontal entre nodos */
      --scale:1;    /* ajustado dinámicamente */
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{height:100%;scroll-behavior:smooth;}
    body{
      font-family:'Inter',Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    /* NAV */
    .navbar{
      position:sticky; top:0; z-index:50;
      width:100%; background:var(--surface);
      box-shadow:0 2px 16px rgba(0,0,0,.05);
      padding:.9rem 1.5rem;
      display:flex; justify-content:center; align-items:center;
    }
    .brand{
      font-family:'Montserrat',sans-serif;
      font-size:1.35rem; font-weight:700;
      color:var(--primary);
      text-decoration:none;
      display:flex; align-items:center; gap:.55rem;
    }
    .brand::before{
      content:""; width:22px; height:22px; border-radius:50%;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      display:inline-block;
    }

    /* HERO */
    .hero{
      text-align:center; color:#fff;
      background:linear-gradient(135deg,var(--primary) 0%,#1d4ed8 65%,#0ea5e9 120%);
      padding:3.3rem 1.2rem 3.8rem;
      width:100%;
    }
    .hero h1{font-family:'Montserrat',sans-serif;font-size:2rem;font-weight:700;margin-bottom:.5rem;}
    .hero p{font-size:.95rem;opacity:.9;max-width:670px;margin:0 auto 1.4rem;}
    #input-section{display:flex;justify-content:center;gap:.6rem;}
    #codigo{
      width:200px; padding:9px 12px; font-size:1rem;
      border:none; border-radius:10px; outline:none;
    }
    #verBtn{
      background:#fff; color:var(--primary); font-weight:600;
      padding:9px 18px; border:none; border-radius:10px;
      cursor:pointer; transition:opacity .15s,transform .12s;
    }
    #verBtn:active{transform:scale(.97);}
    #verBtn[disabled]{opacity:.6;cursor:not-allowed;}

    /* CARD */
    .card{
      width:100%; max-width:1100px;
      background:var(--surface);
      border-radius:var(--radius);
      box-shadow:0 12px 34px rgba(37,99,235,.12);
      padding:2.2rem 1.3rem 2.4rem;
      margin:2rem 0;
      overflow:hidden;
    }
    .chips{
      display:flex;flex-wrap:wrap;justify-content:center;gap:12px;
      margin-bottom:16px;
    }
    .chip{
      background:var(--chip-bg);color:var(--chip-color);
      padding:6px 16px;border-radius:999px;
      font-weight:600;font-size:.9rem;white-space:nowrap;
    }
    #totalPuntos{background:#e2fbe2;color:#15803d;}

    /* ÁRBOL */
    .arbol{
      display:flex;flex-direction:column;align-items:center;
      width:100%;--current-scale:var(--scale);
    }
    .nivel{
      position:relative;
      width:100%;
      transform-origin:top center;
      margin:12px 0;
      transform:scaleX(var(--current-scale)) scaleY(1);
    }
    .fila{
      display:flex;justify-content:space-between;
      width:100%;
    }
    .nodo{
      flex:0 0 var(--node);
      height:var(--node);
      border:2px solid var(--primary);
      border-radius:50%;
      background:#fff;
      box-shadow:0 1px 8px rgba(37,99,235,.15);
      display:flex;flex-direction:column;
      justify-content:center;align-items:center;
      text-align:center;padding:4px;
      cursor:pointer;transition:transform .1s;
    }
    .nodo:hover{transform:scale(1.05);}
    .nodo.raiz{
      background:linear-gradient(135deg,var(--primary),var(--accent));
      border-color:var(--accent);color:#fff;
      box-shadow:0 8px 24px rgba(34,197,94,.25);
    }
    .nodo .nombre{font-weight:700;line-height:1.05;margin-bottom:2px;}
    .nodo .codigo{font-size:.72rem;opacity:.85;}
    .nodo .paq{font-size:.7rem;color:#0ea5e9;}

    .vacio{
      flex:0 0 var(--node);
      height:var(--node);
      border:2px dashed #93c5fd;
      background:#f1f5fe;color:#93c5fd;
      display:flex;align-items:center;justify-content:center;
      font-size:1.9rem;line-height:calc(var(--node)-4px);
    }

    .conectores{
      display:flex;justify-content:space-between;
      width:100%;height:8px;margin-top:4px;
    }
    .conectores span{
      width:46px;border-bottom:2px solid #cbd5e1;
    }

    /* Tooltip */
    #tooltip{
      position:absolute;pointer-events:none;
      background:rgba(0,0,0,.75);color:#fff;
      padding:6px 8px;border-radius:4px;
      font-size:.75rem;white-space:pre-line;
      opacity:0;transition:opacity .15s;
      z-index:100;
    }
  </style>
</head>
<body>

  <header class="navbar">
    <a href="#" class="brand">Red de Acción Masiva</a>
  </header>

  <section class="hero">
    <h1>Así va tu red</h1>
    <p>Ingresa tu código para ver tus primeros 3 niveles. Luego haz clic en cualquier nodo para navegar más profundo.</p>
    <div id="input-section">
      <input type="text" id="codigo" placeholder="RM-0000"/>
      <button id="verBtn">Ver primeros 3 niveles</button>
    </div>
  </section>

  <div class="card">
    <div id="chipsCont" class="chips" style="display:none;"></div>
    <div id="arbolRed" class="arbol"></div>
  </div>

  <div id="tooltip"></div>

  <script>
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRusO2GcoYUtkgNYArBk_q8ApISe1IZodp9PoNYDfMVuZ2Vrs8T6InJNLCvOHTj-Mww1sEcGk33EHAR/pub?output=csv';
    let registros = [];

    // Limpia y busca
    const limpiar = t => (t||'').replace(/"/g,'').trim();
    const buscarPorPatrocinador = p => registros.filter(r => limpiar(r.Patrocinador)===limpiar(p)).slice(0,2);
    const getPorCodigo = c => registros.find(r => limpiar(r['Código Asignado'])===limpiar(c));

    // Construye exactamente 3 niveles (0,1,2)
    function construirTresNiveles(raiz){
      const niveles = [];
      (function rec(arr, lvl){
        niveles.push([...arr]);
        if(lvl===2) return;
        const next = [];
        arr.forEach(n=>{
          if(!n) next.push(null,null);
          else {
            const hijos = buscarPorPatrocinador(n['Código Asignado']);
            next.push(hijos[0]||null, hijos[1]||null);
          }
        });
        rec(next, lvl+1);
      })([raiz], 0);
      return niveles;
    }

    // Métricas (hasta 5 niveles para datos más completos)
    function contarPuntos(nodo, lvl, maxLvl){
      if(!nodo||lvl>maxLvl) return 0;
      const hijos = buscarPorPatrocinador(nodo['Código Asignado']);
      let total = { "ESP 1":100, "ESP 2":250, "ESP 3":500 }[limpiar(nodo.Paquete).toUpperCase()]||0;
      hijos.forEach(h=> total += contarPuntos(h, lvl+1, maxLvl));
      return total;
    }
    function contarRed(nodo, lvl, maxLvl){
      if(!nodo||lvl>maxLvl) return 0;
      const hijos = buscarPorPatrocinador(nodo['Código Asignado']);
      let cnt = hijos.length;
      hijos.forEach(h=> cnt += contarRed(h, lvl+1, maxLvl));
      return cnt;
    }
    function nivelesCompletos(nodo, lvl, maxLvl){
      if(!nodo||lvl>maxLvl) return lvl-1;
      const hijos = buscarPorPatrocinador(nodo['Código Asignado']);
      if(hijos.length<2) return lvl-1;
      return Math.min(
        nivelesCompletos(hijos[0], lvl+1, maxLvl),
        nivelesCompletos(hijos[1], lvl+1, maxLvl)
      );
    }

    // Renderiza chips
    function renderChips(raiz){
      const personas = contarRed(raiz,1,5);
      const nivComp  = nivelesCompletos(raiz,1,5);
      const hijos     = buscarPorPatrocinador(raiz['Código Asignado']);
      const izq       = hijos[0]?contarPuntos(hijos[0],1,5):0;
      const der       = hijos[1]?contarPuntos(hijos[1],1,5):0;
      const totalPts  = izq+der;

      const cont = document.getElementById('chipsCont');
      cont.innerHTML = `
        <span class="chip">Personas en red: <b>${personas}</b></span>
        <span class="chip">Niveles completos: <b>${nivComp}</b></span>
        <span class="chip">Puntos Izq: <b>${izq}</b></span>
        <span class="chip">Puntos Der: <b>${der}</b></span>
        <span class="chip" id="totalPuntos">Total puntos: <b>${totalPts}</b></span>
      `;
      cont.style.display = 'flex';
    }

    // Renderiza 3 niveles y añade click a cada nodo
    function renderArbol(raiz){
      const tree = document.getElementById('arbolRed');
      tree.innerHTML = '';
      const niveles = construirTresNiveles(raiz);

      niveles.forEach((nivelArr, i) => {
        const lvlDiv = document.createElement('div');
        lvlDiv.className = 'nivel';
        const fila = document.createElement('div');
        fila.className = 'fila';

        nivelArr.forEach(nodo => {
          const div = document.createElement('div');
          if(!nodo) {
            div.className='vacio';
            div.textContent = '+';
          } else {
            div.className = 'nodo' + (i===0?' raiz':'');
            div.innerHTML = `
              <div class="nombre">${nodo.Nombre}</div>
              <div class="codigo">${nodo['Código Asignado']}</div>
              <div class="paq">${nodo.Paquete}</div>
            `;
            // clic para navegar
            div.addEventListener('click', ()=> {
              showNodo(nodo['Código Asignado']);
            });
            // tooltip
            div.dataset.tooltip = `${nodo.Nombre}\n${nodo['Código Asignado']}\n${nodo.Paquete}`;
          }
          fila.appendChild(div);
        });

        lvlDiv.appendChild(fila);

        // conectores
        if(i < niveles.length - 1){
          const cons = document.createElement('div');
          cons.className = 'conectores';
          niveles[i].forEach(_=> cons.innerHTML += '<span></span>');
          lvlDiv.appendChild(cons);
        }

        tree.appendChild(lvlDiv);
      });

      ajustarEscalaGlobal(niveles.length);
    }

    // Ajusta --scale para que ocupen ancho
    function ajustarEscalaGlobal(numLevels){
      const container = document.querySelector('.card');
      const available = container.clientWidth - 32;
      const nodeSize  = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--node'));
      const gap       = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap'));
      let maxNodes = Math.max(...new Array(numLevels).fill().map((_,i)=>(i===0?1:Math.pow(2,i))));
      const required = maxNodes * nodeSize + (maxNodes - 1) * gap;
      let scale = available / required;
      scale = Math.min(1, Math.max(0.45, scale));
      document.documentElement.style.setProperty('--scale', scale);
    }

    // Mostrar un nodo, recalc métricas y arbol
    function showNodo(codigo){
      const raiz = getPorCodigo(codigo);
      if(!raiz) return;
      renderChips(raiz);
      renderArbol(raiz);
    }

    // Primer carga
    document.getElementById('verBtn').addEventListener('click', ()=>{
      const code = document.getElementById('codigo').value.trim();
      if(!code) return alert('Escribe tu código.');
      if(registros.length === 0){
        fetch(SHEET_CSV_URL)
          .then(r=>r.text())
          .then(csv=>{
            const rows = csv.split('\n');
            const headers = rows[0].split(',').map(limpiar);
            registros = rows.slice(1).map(r=>{
              const cols = r.split(','), o={};
              headers.forEach((h,i)=>o[h]=limpiar(cols[i]||''));
              return o;
            });
            showNodo(code);
          })
          .catch(()=>alert('Error al cargar datos.'));
      } else {
        showNodo(code);
      }
    });

    // Tooltip logic
    const tip = document.getElementById('tooltip');
    document.body.addEventListener('mousemove', e=>{
      const tgt = e.target.closest('[data-tooltip]');
      if(tgt){
        tip.textContent = tgt.dataset.tooltip;
        tip.style.left = e.pageX + 10 + 'px';
        tip.style.top  = e.pageY + 10 + 'px';
        tip.style.opacity = 1;
      } else {
        tip.style.opacity = 0;
      }
    });
  </script>

</body>
</html>
