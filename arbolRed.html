<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Así va tu red</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      /* Cambia colores aquí si quieres */
      --primary:#1d4ed8;   /* azul */
      --accent:#9333ea;    /* morado */
      --bg:#f1f5f9;
      --surface:#ffffff;
      --text:#0f172a;
      --text-light:#64748b;
      --info-chip:#e0f2fe;
    }
    *{box-sizing:border-box;}
    body{background:var(--bg);font-family:'Inter',Arial,sans-serif;color:var(--text);}
    .container{
      max-width:1050px;margin:32px auto;background:var(--surface);border-radius:18px;
      box-shadow:0 6px 32px rgba(60,90,200,.12);padding:2.2rem 1rem 2.6rem;
    }
    h1{text-align:center;color:var(--primary);margin-bottom:6px;font-size:2rem;}
    .subtitle{text-align:center;color:var(--text-light);font-size:1.05rem;margin-bottom:22px;}
    #input-section{display:flex;justify-content:center;gap:12px;margin-bottom:16px;flex-wrap:wrap;}
    #codigo{
      font-size:1.05rem;padding:8px 15px;border-radius:9px;border:1.5px solid #b6c6e3;width:230px;
    }
    button{
      background:linear-gradient(90deg,var(--primary) 75%,var(--accent) 130%);
      color:#fff;font-weight:700;padding:9px 26px;border-radius:9px;border:none;cursor:pointer;
      transition:background .18s,transform .13s;font-size:1.04rem;
    }
    button:active{transform:scale(.96);}

    /* Chips resumen */
    .top-summary{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;margin:14px 0 8px;}
    .summary-item{
      background:var(--info-chip);color:var(--primary);font-weight:600;font-size:.98rem;
      padding:7px 18px;border-radius:12px;
    }
    .summary-total{
      text-align:center;background:#dbeafe;color:#1e40af;font-weight:700;font-size:1.06rem;
      padding:7px 0;border-radius:10px;margin:8px 0 0;
    }

    /* Árbol */
    .arbol{display:flex;flex-direction:column;align-items:center;margin-top:16px;width:100%;}
    .nivel{
      display:flex;flex-wrap:wrap;justify-content:center;gap:18px;margin:18px 0 0;width:100%;
    }
    .nodo{
      background:#fff;border:2.3px solid var(--primary);border-radius:50%;
      width:86px;height:86px;padding:6px 4px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      box-shadow:0 1px 8px rgba(0,0,0,.08);position:relative;
      flex:0 0 auto;
    }
    .nodo .nombre{
      color:var(--primary);font-weight:700;font-size:.9rem;
      max-width:72px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .nodo .codigo{color:#64748b;font-size:.78rem;line-height:1;}
    .nodo .paquete{color:#0ea5e9;font-size:.74rem;margin-top:1px;}
    .nodo.raiz{
      background:linear-gradient(135deg,var(--primary) 0%,var(--accent) 120%);
      color:#fff;border:2.3px solid var(--accent);box-shadow:0 4px 18px #9333ea40;
    }
    .nodo.raiz .nombre,.nodo.raiz .codigo,.nodo.raiz .paquete{color:#fff;}
    .nodo.vacio{
      color:#a3a3a3;background:#f7fafc;border-style:dashed;border-color:#b6c6e3;font-style:italic;
    }
    .nodo.vacio span{font-size:2rem;color:#bae6fd;line-height:0;}

    /* Botón flotante para niveles extra */
    #toggleNivelesBtn{
      position:fixed;right:26px;bottom:30px;z-index:99;
      background:linear-gradient(90deg,#10b981 20%,var(--primary) 110%);
      color:#fff;border:none;border-radius:22px;padding:12px 26px;font-size:1.05rem;font-weight:700;
      box-shadow:0 6px 32px #2563eb22;cursor:pointer;display:none;align-items:center;gap:10px;
    }
    #toggleNivelesBtn:hover{background:linear-gradient(90deg,#0ea5e9 0%,var(--primary) 110%);}
    #mensajeError{color:#e11d48;text-align:center;margin-top:1rem;font-size:1rem;}

    @media(max-width:920px){
      .container{padding:1rem .5rem 2rem;}
      .nodo{width:70px;height:70px;}
      .nodo .nombre{font-size:.78rem;max-width:58px;}
    }
    @media(max-width:600px){
      .nodo{width:56px;height:56px;padding:3px;}
      .nodo .nombre{font-size:.65rem;max-width:46px;}
      .nodo .codigo{font-size:.65rem;}
      .nodo .paquete{font-size:.6rem;}
      #toggleNivelesBtn{right:12px;bottom:18px;font-size:.9rem;padding:9px 18px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Así va tu red</h1>
    <div class="subtitle">Proceso previo a la inscripción en Gano Excel</div>

    <div id="input-section">
      <input type="text" id="codigo" placeholder="Ingresa tu código asignado" />
      <button onclick="generarArbol()">Ver árbol</button>
    </div>

    <div id="topResumen"></div>
    <div id="arbolRed" class="arbol"></div>
    <div id="mensajeError"></div>
  </div>

  <button id="toggleNivelesBtn" onclick="toggleNiveles()">
    <span id="iconoToggle">+ </span>Niveles
  </button>

  <script>
    /* CONFIG */
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRusO2GcoYUtkgNYArBk_q8ApISe1IZodp9PoNYDfMVuZ2Vrs8T6InJNLCvOHTj-Mww1sEcGk33EHAR/pub?output=csv';

    let registros = [];
    let maxNivelRed = 5;
    let maxNivelVisible = 3;
    let ultimoCodigo = '';

    const limpiar = t => (t||'').replace(/"/g,'').trim();
    function puntosPorPaquete(p){
      switch(limpiar(p).toUpperCase()){
        case 'ESP 1': return 100;
        case 'ESP 2': return 250;
        case 'ESP 3': return 500;
        default: return 0;
      }
    }
    const getPorCodigo = c => registros.find(r => limpiar(r['Código Asignado'])===limpiar(c));
    function buscarPorPatrocinador(p){
      return registros.filter(r => limpiar(r.Patrocinador)===limpiar(p)).slice(0,2);
    }
    function contarPuntosRama(nodo, lvl, max){
      if(!nodo || lvl>max) return 0;
      const hijos = buscarPorPatrocinador(nodo['Código Asignado']);
      let tot = puntosPorPaquete(nodo.Paquete);
      for(const h of hijos){ tot += contarPuntosRama(h,lvl+1,max); }
      return tot;
    }
    function contarRed(nodo, lvl, max){
      if(!nodo || lvl>max) return 0;
      const hijos = buscarPorPatrocinador(nodo['Código Asignado']);
      let total = hijos.length;
      for(const h of hijos){ total += contarRed(h,lvl+1,max); }
      return total;
    }
    function nivelesCompletos(nodo, lvl, max){
      if(!nodo || lvl>max) return lvl-1;
      const hijos = buscarPorPatrocinador(nodo['Código Asignado']);
      if(hijos.length<2) return lvl-1;
      return Math.min(
        nivelesCompletos(hijos[0],lvl+1,max),
        nivelesCompletos(hijos[1],lvl+1,max)
      );
    }

    /* Construye niveles sólo hasta que existan nodos */
    function construirNiveles(raiz, max){
      const niveles=[];
      function rec(nodos, nivel){
        if(nivel>max) return;
        niveles.push(nodos);
        let next=[];
        let hayAlguien=false;
        nodos.forEach(n=>{
          if(n){
            const hijos=buscarPorPatrocinador(n['Código Asignado']);
            const iz=hijos[0]||null, der=hijos[1]||null;
            next.push(iz,der);
            if(iz||der) hayAlguien=true;
          }else{
            // no empujes hijos si no existe el padre, para evitar "ruido" abajo
          }
        });
        if(hayAlguien) rec(next,nivel+1);
      }
      rec([raiz],1);
      return niveles;
    }

    function renderArbol(niveles){
      let html='';
      const limite = Math.min(maxNivelVisible, niveles.length);
      for(let i=0;i<limite;i++){
        html += `<div class="nivel">`;
        niveles[i].forEach(node=>{
          if(!node){
            html += `<div class="nodo vacio"><span>+</span></div>`;
          }else{
            html += `<div class="nodo ${i===0?'raiz':''}">
                        <div class="nombre">${node.Nombre||''}</div>
                        <div class="codigo">${node['Código Asignado']||''}</div>
                        <div class="paquete">${node.Paquete||''}</div>
                     </div>`;
          }
        });
        html += `</div>`;
      }
      document.getElementById('arbolRed').innerHTML = html;
    }

    function generarArbol(){
      document.getElementById('mensajeError').innerText='';
      document.getElementById('topResumen').innerHTML='';
      document.getElementById('arbolRed').innerHTML='';
      const codigo = document.getElementById('codigo').value.trim();
      ultimoCodigo = codigo;
      if(!codigo){
        document.getElementById('mensajeError').innerText='Debes ingresar tu código asignado.';
        return;
      }

      const btn=document.querySelector('#input-section button');
      const oldTxt=btn.innerText;
      btn.disabled=true; btn.innerText='Buscando...';

      fetch(SHEET_CSV_URL)
        .then(r=>r.text())
        .then(csv=>{
          const rows=csv.split('\n');
          const headers=rows[0].split(',').map(limpiar);
          registros = rows.slice(1).map(line=>{
            const cols=line.split(',');
            const obj={}; headers.forEach((k,i)=>obj[k]=limpiar(cols[i]));
            return obj;
          });

          const raiz=getPorCodigo(codigo);
          if(!raiz){
            document.getElementById('mensajeError').innerText='No se encontró el código en la base de datos.';
            btn.disabled=false; btn.innerText=oldTxt; return;
          }

          const hijos=buscarPorPatrocinador(raiz['Código Asignado']);
          const izq=hijos[0]?contarPuntosRama(hijos[0],1,maxNivelRed):0;
          const der=hijos[1]?contarPuntosRama(hijos[1],1,maxNivelRed):0;
          const total=izq+der;

          document.getElementById('topResumen').innerHTML=`
            <div class="top-summary">
              <div class="summary-item">Personas en red: <b>${contarRed(raiz,1,maxNivelRed)}</b></div>
              <div class="summary-item">Niveles completos: <b>${nivelesCompletos(raiz,1,maxNivelRed)}</b></div>
              <div class="summary-item">Puntos Izq: <b>${izq}</b></div>
              <div class="summary-item">Puntos Der: <b>${der}</b></div>
            </div>
            <div class="summary-total">Total puntos: ${total}</div>
          `;

          const niveles = construirNiveles(raiz,maxNivelRed);
          renderArbol(niveles);

          const toggleBtn=document.getElementById('toggleNivelesBtn');
          if(niveles.length>3){
            toggleBtn.style.display='flex';
            document.getElementById('iconoToggle').textContent = maxNivelVisible===3 ? '+ ' : '- ';
          }else{
            toggleBtn.style.display='none';
          }

          btn.disabled=false; btn.innerText=oldTxt;
        })
        .catch(err=>{
          document.getElementById('mensajeError').innerText='No se pudo consultar la base de datos.';
          btn.disabled=false; btn.innerText=oldTxt;
          console.error(err);
        });
    }

    function toggleNiveles(){
      maxNivelVisible = (maxNivelVisible===3)?5:3;
      if(ultimoCodigo) generarArbol();
    }
  </script>
</body>
</html>


