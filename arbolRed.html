<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Red de Acción Masiva — Navegación por niveles</title>

  <link rel="preconnect" href="https://fonts.gstatic.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --primary: #2563eb;
      --accent: #22c55e;
      --bg: #f1f5f9;
      --surface: #ffffff;
      --text: #0f172a;
      --node: 92px;
      --gap: 24px;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family:'Inter',Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex; flex-direction:column; align-items:center;
    }
    h1 { margin:1rem 0; }
    #codigo { padding:8px; font-size:1rem; }
    #verBtn { margin-left:.5rem; }

    .card {
      width:100%; max-width:1100px;
      background:var(--surface);
      border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,.05);
      padding:1.5rem; margin-bottom:2rem;
    }
    .arbol { display:flex; flex-direction:column; gap:1rem; }
    .nivel {
      display:flex; justify-content:space-between;
      width:100%;
    }
    .nodo {
      flex:0 0 var(--node); height:var(--node);
      border:2px solid var(--primary); border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      text-align:center; padding:4px; background:#fff;
      cursor:pointer; transition:transform .1s;
    }
    .nodo:hover { transform:scale(1.05); }
    .nodo.raiz {
      background:linear-gradient(135deg,var(--primary),var(--accent));
      border-color:var(--accent); color:#fff;
    }
    .tooltip {
      position:absolute; pointer-events:none;
      background:rgba(0,0,0,.75); color:#fff;
      padding:6px 8px; border-radius:4px;
      font-size:.75rem; white-space:pre-line;
      z-index:10; opacity:0; transition:opacity .15s;
    }
  </style>
</head>
<body>

  <h1>Red de Acción Masiva</h1>
  <div>
    <input id="codigo" placeholder="RM-0000"/>
    <button id="verBtn">Cargar niveles</button>
  </div>

  <div class="card">
    <div id="arbolRed" class="arbol"></div>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <script>
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRusO2GcoYUtkgNYArBk_q8ApISe1IZodp9PoNYDfMVuZ2Vrs8T6InJNLCvOHTj-Mww1sEcGk33EHAR/pub?output=csv';
    let registros = [];

    // Utiles
    const limpiar = t => (t||'').replace(/"/g,'').trim();
    const buscar = p => registros.filter(r=>limpiar(r.Patrocinador)===limpiar(p)).slice(0,2);
    const getNodo = c => registros.find(r=>limpiar(r['Código Asignado'])===limpiar(c));

    // Construye exactamente N niveles descendientes
    function construir(root, niveles) {
      const res = [];
      function rec(nodos, nivel) {
        if(nivel>niveles) return;
        res.push(nodos);
        const sig = [];
        nodos.forEach(n=>{
          if(!n) sig.push(null,null);
          else {
            const h = buscar(n['Código Asignado']);
            sig.push(h[0]||null, h[1]||null);
          }
        });
        rec(sig, nivel+1);
      }
      rec([root], 0);
      return res;
    }

    function render(nivelPadreCodigo) {
      const root = getNodo(nivelPadreCodigo);
      if(!root) return alert('Código no encontrado');
      const niveles = construir(root, 2); // raíz + 2 descendientes = 3 filas
      const cont = document.getElementById('arbolRed');
      cont.innerHTML = '';

      niveles.forEach((fil, i) => {
        const filaDiv = document.createElement('div');
        filaDiv.className = 'nivel';
        fil.forEach(n=>{
          const div = document.createElement('div');
          if(!n) {
            div.className='nodo';
            div.textContent='+';
            div.style.borderStyle='dashed';
          } else {
            div.className = 'nodo'+(i===0?' raiz':'');
            // en niveles 1 y 2 mostramos solo la inicial
            if(i>0) {
              div.textContent = (n.Nombre||'')[0] || '';
              // attach tooltip data
              div.dataset.tooltip = `${n.Nombre}\n${n['Código Asignado']}\n${n.Paquete}`;
            } else {
              div.innerHTML = `<div>${n.Nombre}</div><small>${n['Código Asignado']}</small>`;
            }
            // click para profundizar en este nodo
            div.onclick = ()=> render(n['Código Asignado']);
          }
          filaDiv.appendChild(div);
        });
        cont.appendChild(filaDiv);
      });
    }

    // Tooltip
    const tip = document.getElementById('tooltip');
    document.body.addEventListener('mousemove', e=>{
      const tgt = e.target.closest('.nodo[data-tooltip]');
      if(tgt) {
        tip.textContent = tgt.dataset.tooltip;
        tip.style.left = e.pageX + 10 + 'px';
        tip.style.top  = e.pageY + 10 + 'px';
        tip.style.opacity = 1;
      } else {
        tip.style.opacity = 0;
      }
    });

    // Carga inicial de datos
    document.getElementById('verBtn').onclick = ()=>{
      const code = document.getElementById('codigo').value.trim();
      if(!code) return alert('Ingresa un código');
      if(registros.length===0) {
        fetch(SHEET_CSV_URL).then(r=>r.text()).then(csv=>{
          const rows = csv.split('\n'), headers = rows[0].split(',').map(limpiar);
          registros = rows.slice(1).map(r=>{
            const cols = r.split(','), o={};
            headers.forEach((h,i)=>o[h]=limpiar(cols[i]));
            return o;
          });
          render(code);
        }).catch(()=>alert('Error al cargar datos'));
      } else {
        render(code);
      }
    };
  </script>

</body>
</html>
