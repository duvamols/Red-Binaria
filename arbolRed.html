<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Así va tu red | Red de Acción Masiva</title>

<link rel="preconnect" href="https://fonts.gstatic.com" />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet" />
<style>
:root{
    --primary:#2563eb;
    --primary-dark:#1d4ed8;
    --accent:#22c55e;
    --bg:#f1f5f9;
    --surface:#ffffff;
    --text:#0f172a;
    --chip-bg:#e0f2fe;
    --chip-color:#2563eb;
    --radius:18px;

    --node:92px;   /* tamaño base del nodo */
    --gap:24px;    /* espacio horizontal entre nodos */
    --scale:1;     /* se ajusta desde JS */
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;scroll-behavior:smooth;}
body{
    font-family:'Inter', Arial, sans-serif;
    color:var(--text);
    background:var(--bg);
    display:flex;
    flex-direction:column;
    align-items:center;
}

/* NAV */
.navbar{ /* ... mismo que antes ... */ }
.brand{ /* ... */ }
.brand::before{ /* ... */ }

/* HERO */
.hero{ /* ... */ }
.hero h1{ /* ... */ }
.hero p{ /* ... */ }
#input-section{ /* ... */ }
#codigo{ /* ... */ }
#verBtn{ /* ... */ }

/* CARD */
.wrapper{ /* ... */ }
.card{ /* ... */ }
.chips{ /* ... */ }
.chip{ /* ... */ }
#totalPuntos{ /* ... */ }

/* TREE */
.arbol{
    display:flex; flex-direction:column; align-items:center;
    width:100%; margin-top:8px;
    --current-scale:var(--scale);
}
.nivel{
    position:relative; width:100%;
    transform-origin:top center;
    margin:18px 0;
    /* solo escalado horizontal */
    transform:scaleX(var(--current-scale)) scaleY(1);
}
.fila{
    display:flex; justify-content:center; gap:var(--gap);
}

/* node */
.nodo{
    flex:0 0 var(--node);
    height:var(--node);
    border-radius:50%;
    border:2px solid var(--primary);
    background:#fff;
    box-shadow:0 1px 8px rgba(37,99,235,.15);
    display:flex; flex-direction:column; justify-content:center; align-items:center;
    text-align:center; padding:4px;
    font-size:.8rem; color:var(--primary);
    cursor:pointer;
    transition:transform .1s;
}
.nodo:hover{transform:scale(1.05);}
.nodo.raiz{ /* ... igual ... */ }
.nodo .nombre{ /* ... */ }
.nodo .codigo{ /* ... */ }
.nodo .paq{ /* ... */ }
.vacio{ /* ... */ }

/* connectors */
.conectores{ /* ... */ }
.conectores span{ /* ... */ }

/* tooltip */
#tooltip{ /* ... */ }
</style>
</head>
<body>

<header class="navbar">
  <a href="#" class="brand">Red de Acción Masiva</a>
</header>

<section class="hero">
  <h1>Así va tu red</h1>
  <p>Ingresa tu código para ver tus primeros 4 niveles. Haz clic en cualquier nodo para navegar sus niveles.</p>
  <div id="input-section">
    <input type="text" id="codigo" placeholder="RM-0000" />
    <button id="verBtn">Ver 4 niveles</button>
  </div>
</section>

<main class="wrapper">
  <div class="card">
    <div id="chipsCont" class="chips" style="display:none;"></div>
    <div id="arbolRed" class="arbol"></div>
    <div id="mensajeError"></div>
  </div>
</main>

<div id="tooltip"></div>

<script>
// ---- CONFIG ----
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/.../pub?output=csv';
let registros = [];
let nivelesData = [];
let raizGlobal = null;

const SHOW_DESC = 3;     // mostramos 3 niveles descendientes -> 4 niveles totales
const METRIC_DESC = 5;   // métricas siguen hasta 5 niveles

// ---- UTIL ----
const limpiar = t => (t||'').replace(/"/g,'').trim();
function buscarPorPatrocinador(p){
    return registros.filter(r=>limpiar(r.Patrocinador)===limpiar(p)).slice(0,2);
}
function getPorCodigo(c){
    return registros.find(r=>limpiar(r['Código Asignado'])===limpiar(c));
}

// ---- MÉTRICAS ----
function puntosPorPaquete(p){
    switch(limpiar(p).toUpperCase()){
        case "ESP 1": return 100;
        case "ESP 2": return 250;
        case "ESP 3": return 500;
        default: return 0;
    }
}
function contarPuntos(nodo, lvl){
    if(!nodo||lvl>METRIC_DESC) return 0;
    const hijos = buscarPorPatrocinador(nodo['Código Asignado']);
    let total = puntosPorPaquete(nodo.Paquete);
    hijos.forEach(h=> total += contarPuntos(h, lvl+1));
    return total;
}
function contarRed(nodo, lvl){
    if(!nodo||lvl>METRIC_DESC) return 0;
    const hijos = buscarPorPatrocinador(nodo['Código Asignado']);
    let cnt = hijos.length;
    hijos.forEach(h=> cnt += contarRed(h, lvl+1));
    return cnt;
}
function nivCompletos(nodo, lvl){
    if(!nodo||lvl>METRIC_DESC) return lvl-1;
    const hijos = buscarPorPatrocinador(nodo['Código Asignado']);
    if(hijos.length<2) return lvl-1;
    return Math.min(
      nivCompletos(hijos[0], lvl+1),
      nivCompletos(hijos[1], lvl+1)
    );
}

// ---- CONSTRUIR ----
//  Raíz + SHOW_DESC niveles
function construir(raiz){
    const res = [];
    (function rec(arr, lvl){
        res.push([...arr]);
        if(lvl===SHOW_DESC) return;
        const next = [];
        arr.forEach(n=>{
            if(!n) next.push(null,null);
            else {
                const h = buscarPorPatrocinador(n['Código Asignado']);
                next.push(h[0]||null, h[1]||null);
            }
        });
        rec(next, lvl+1);
    })([raiz], 0);
    return res;
}

// ---- RENDER CHIPS ----
function renderChips(raiz){
    const hijos = buscarPorPatrocinador(raiz['Código Asignado']);
    const izq = contarPuntos(hijos[0],1);
    const der = contarPuntos(hijos[1],1);
    const total = izq + der;
    const personas = contarRed(raiz,1);
    const nivComp  = nivCompletos(raiz,1);

    const cont = document.getElementById('chipsCont');
    cont.innerHTML = `
      <span class="chip">Personas en red: <b>${personas}</b></span>
      <span class="chip">Niveles completos: <b>${nivComp}</b></span>
      <span class="chip">Puntos Izq: <b>${izq}</b></span>
      <span class="chip">Puntos Der: <b>${der}</b></span>
      <span class="chip" id="totalPuntos">Total puntos: <b>${total}</b></span>
    `;
    cont.style.display = 'flex';
}

// ---- RENDER ÁRBOL ----
function renderArbol(){
    const tree = document.getElementById('arbolRed');
    tree.innerHTML = '';
    nivelesData = construir(raizGlobal);

    nivelesData.forEach((filaArr, i)=>{
      const lvlDiv = document.createElement('div');
      lvlDiv.className = 'nivel';
      const fila = document.createElement('div');
      fila.className = 'fila';

      filaArr.forEach(n=>{
        const d = document.createElement('div');
        if(!n){
          d.className='vacio'; d.textContent='+';
        } else {
          d.className='nodo'+(i===0?' raiz':'');
          d.innerHTML = `
            <div class="nombre">${n.Nombre}</div>
            <div class="codigo">${n['Código Asignado']}</div>
            <div class="paq">${n.Paquete}</div>
          `;
          // navegación
          d.onclick = ()=> showNode(n['Código Asignado']);
          // tooltip
          d.dataset.tooltip = `${n.Nombre}\n${n['Código Asignado']}\n${n.Paquete}`;
        }
        fila.appendChild(d);
      });

      lvlDiv.appendChild(fila);
      if(i < nivelesData.length-1){
        const c = document.createElement('div');
        c.className = 'conectores';
        nivelesData[i].forEach(_=> c.innerHTML += '<span></span>');
        lvlDiv.appendChild(c);
      }
      tree.appendChild(lvlDiv);
    });

    ajustarEscalaGlobal();
}

// ---- ESCALA ----
function ajustarEscalaGlobal(){
    const cont = document.querySelector('.card').clientWidth - 32;
    const sz = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--node'));
    const gap= parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap'));
    const maxN = Math.pow(2, SHOW_DESC);
    const req = maxN * sz + (maxN - 1)*gap;
    let s = cont/req; s = Math.min(1, Math.max(0.45, s));
    document.documentElement.style.setProperty('--scale', s);
}

// ---- NAVEGAR ----
function showNode(code){
  const nodo = getPorCodigo(code);
  if(!nodo) return;
  raizGlobal = nodo;
  renderChips(nodo);
  renderArbol();
}

// ---- INICIO ----
document.getElementById('verBtn').onclick = ()=>{
  const code = document.getElementById('codigo').value.trim();
  if(!code) return alert('Ingresa tu código');
  if(!registros.length){
    fetch(SHEET_CSV_URL).then(r=>r.text()).then(txt=>{
      const rows = txt.split('\n');
      const hdrs = rows[0].split(',').map(limpiar);
      registros = rows.slice(1).map(r=>{
        const cols = r.split(','), o={};
        hdrs.forEach((h,i)=>o[h]=limpiar(cols[i]||''));
        return o;
      });
      const root = getPorCodigo(code);
      if(!root) return alert('Código no válido');
      raizGlobal = root;
      renderChips(root);
      renderArbol();
    }).catch(()=>alert('Error al cargar datos'));
  } else {
    const root = getPorCodigo(code);
    if(!root) return alert('Código no válido');
    raizGlobal = root;
    renderChips(root);
    renderArbol();
  }
};

// ---- TOOLTIP ----
const tip = document.getElementById('tooltip');
document.body.addEventListener('mousemove', e=>{
  const tgt = e.target.closest('[data-tooltip]');
  if(tgt){
    tip.textContent = tgt.dataset.tooltip;
    tip.style.left = e.pageX + 10 + 'px';
    tip.style.top  = e.pageY + 10 + 'px';
    tip.style.opacity = 1;
  } else tip.style.opacity = 0;
});
</script>

</body>
</html>


