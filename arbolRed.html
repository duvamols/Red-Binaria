<!DOCTYPE html>
<html lang='es'>
<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0' />
  <title>As√≠ va tu red | Red de Acci√≥n Masiva</title>

  <link rel='preconnect' href='https://fonts.gstatic.com' />
  <link href='https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@400;500&display=swap' rel='stylesheet' />
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --accent: #22c55e;
      --bg: #f1f5f9;
      --surface: #ffffff;
      --text: #0f172a;
      --text-light: #64748b;
      --chip-bg: #e0f2fe;
      --chip-color: #2563eb;
      --radius: 18px;
      --node: 92px;   /* tama√±o base del nodo */
      --gap: 24px;    /* espacio horizontal entre nodos */
      --scale: 1;     /* se ajusta desde JS */
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; scroll-behavior: smooth; }
    body {
      font-family: 'Inter', Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      display: flex;
      flex-direction: column;
    }

    /* NAV */
    .navbar {
      position: sticky; top: 0; z-index: 50;
      width: 100%;
      background: var(--surface);
      box-shadow: 0 2px 16px rgba(0,0,0,.05);
      padding: .9rem 1.5rem;
      display: flex; justify-content: center; align-items: center;
    }
    .brand {
      font-family: 'Montserrat', sans-serif;
      font-size: 1.35rem;
      font-weight: 700;
      color: var(--primary);
      display: flex; align-items: center; gap: .55rem;
      text-decoration: none;
    }
    .brand::before {
      content: '';
      width: 22px; height: 22px; border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: inline-block;
    }

    /* HERO */
    .hero {
      width: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 65%, #0ea5e9 120%);
      color: #fff;
      padding: 3.3rem 1.2rem 3.8rem 1.2rem;
      text-align: center;
    }
    .hero h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: .5rem;
    }
    .hero p {
      font-size: .95rem;
      opacity: .9;
      max-width: 670px;
      margin: 0 auto 1.4rem auto;
    }
    #input-section {
      display: flex; justify-content: center; gap: .6rem; margin-top: .9rem;
    }
    #codigo {
      font-size: 1rem;
      padding: 9px 12px;
      border-radius: 10px;
      border: none;
      outline: none;
      width: 200px;
    }
    #verBtn {
      background: #fff;
      color: var(--primary);
      font-weight: 600;
      padding: 9px 18px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: opacity .15s, transform .12s;
    }
    #verBtn:active { transform: scale(.97); }
    #verBtn[disabled] { opacity: .6; cursor: not-allowed; }

    /* CARD */
    .wrapper {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 0 1rem;
      transform: translateY(-48px);
      margin-bottom: -48px;
    }
    .card {
      width: 100%;
      max-width: 1100px;
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: 0 12px 34px rgba(37,99,235,.12);
      padding: 2.2rem 1.3rem 2.4rem 1.3rem;
      overflow: hidden;
    }
    .nav-buttons {
      display: none;
      gap: 8px;
      margin-bottom: 16px;
    }
    .nav-buttons button {
      background: var(--surface);
      border: 1px solid var(--primary);
      color: var(--primary);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    .nav-buttons button:hover {
      background: var(--primary);
      color: #fff;
    }
    .chips {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;
      margin-bottom: 16px;
    }
    .chip {
      background: var(--chip-bg);
      color: var(--chip-color);
      padding: 6px 16px;
      border-radius: 999px;
      font-size: .9rem;
      font-weight: 600;
      white-space: nowrap;
    }
    #totalPuntos { background: #e2fbe2; color: #15803d; }

    /* TREE */
    .arbol {
      display: flex; flex-direction: column; align-items: center;
      width: 100%;
      margin-top: 8px;
      --current-scale: var(--scale);
    }
    .nivel {
      position: relative;
      transform-origin: top center;
      margin: 12px 0;
      transform: scaleX(var(--current-scale)) scaleY(1);
    }
    .fila {
      display: flex; justify-content: center; gap: var(--gap);
    }
    .nodo {
      width: var(--node);
      height: var(--node);
      border-radius: 50%;
      border: 2px solid var(--primary);
      background: #fff;
      box-shadow: 0 1px 8px rgba(37,99,235,.15);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      text-align: center; padding: 4px;
      font-size: .8rem; color: var(--primary);
      cursor: pointer;
    }
    .nodo.raiz {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-color: var(--accent);
      color: #fff;
      box-shadow: 0 8px 24px rgba(34,197,94,.25);
    }
    .nodo .nombre { font-weight: 700; line-height: 1.05; margin-bottom: 2px; }
    .nodo .codigo { font-size: .72rem; opacity: .85; }
    .nodo .paq { font-size: .7rem; color: #0ea5e9; }
    .vacio {
      border-style: dashed; border-color: #93c5fd;
      background: #f1f5fe; color: #93c5fd;
      font-size: 1.9rem; line-height: calc(var(--node) - 4px);
    }
    .conectores {
      display: flex; justify-content: center;
      gap: calc(var(--gap) + var(--node) - 46px);
      height: 14px; margin-top: 6px;
    }
    .conectores span {
      display: block; width: 46px; border-bottom: 2px solid #cbd5e1;
    }
    @media (max-width:740px) {
      :root { --node: 74px; --gap: 18px; }
      .nivel { margin: 10px 0; }
      .chip { font-size: .8rem; padding: 5px 13px; }
    }
    @media (max-width:480px) {
      .chips { gap: 8px; }
    }
  </style>
</head>
<body>
  <header class='navbar'>
    <a href='#' class='brand'>Red de Acci√≥n Masiva</a>
  </header>

  <section class='hero'>
    <h1>As√≠ va tu red</h1>
    <p>Proceso previo a la inscripci√≥n en Gano Excel. Ingresa tu c√≥digo para ver tu estructura binaria hasta 4 niveles (sin contar tu propia posici√≥n).</p>
    <div id='input-section'>
      <input type='text' id='codigo' placeholder='RM-0000' />
      <button id='verBtn' onclick='generarArbol()'>Ver √°rbol</button>
    </div>
  </section>

  <main class='wrapper'>
    <div class='card'>
      <div id='navButtons' class='nav-buttons'></div>
      <div id='chipsCont' class='chips' style='display:none;'></div>
      <div id='arbolRed' class='arbol'></div>
      <div id='mensajeError'></div>
    </div>
  </main>

  <script>
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRusO2GcoYUtkgNYArBk_q8ApISe1IZodp9PoNYDfMVuZ2Vrs8T6InJNLCvOHTj-Mww1sEcGk33EHAR/pub?output=csv';
    let registros = [], nivelesData = [], raizGlobal = null, initialRoot = null, historyStack = [];
    const MAX_DESC = 3;
    const limpiarTexto = t => (t||'').replace(/"/g,'').trim();
    function buscarPorPatrocinador(p){ return registros.filter(x=>limpiarTexto(x.Patrocinador)===limpiarTexto(p)).slice(0,2); }
    function getPorCodigo(c){ return registros.find(x=>limpiarTexto(x['C√≥digo Asignado'])===limpiarTexto(c)); }
    function puntosPorPaquete(p){ switch(limpiarTexto(p).toUpperCase()){ case 'ESP 1': return 100; case 'ESP 2': return 250; case 'ESP 3': return 500; default: return 0; } }
    function contarPuntosRama(nodo,nivel,maxNivel){ if(!nodo||nivel>maxNivel) return 0; const hijos = buscarPorPatrocinador(nodo['C√≥digo Asignado']); let total = puntosPorPaquete(nodo.Paquete); for(const h of hijos) total += contarPuntosRama(h,nivel+1,maxNivel); return total; }
    function contarRed(nodo,nivel,maxNivel){ if(!nodo||nivel>maxNivel) return 0; const hijos = buscarPorPatrocinador(nodo['C√≥digo Asignado']); let total = hijos.length; for(const h of hijos) total += contarRed(h,nivel+1,maxNivel); return total; }
    function nivelesCompletos(nodo,nivel,maxNivel){ if(!nodo||nivel>maxNivel) return nivel-1; const hijos = buscarPorPatrocinador(nodo['C√≥digo Asignado']); if(hijos.length<2) return nivel-1; return Math.min(nivelesCompletos(hijos[0],nivel+1,maxNivel), nivelesCompletos(hijos[1],nivel+1,maxNivel)); }
    function construirNiveles(nodos, lvlActual, maxDesc){ const niveles=[]; (function rec(actual,lvl){ niveles.push([...actual]); if(lvl===maxDesc) return; const siguiente=[]; actual.forEach(n => { if(!n){ siguiente.push(null,null); } else { const h = buscarPorPatrocinador(n['C√≥digo Asignado']); siguiente.push(h[0]||null,h[1]||null); } }); rec(siguiente,lvl+1); })(nodos,lvlActual); return niveles; }
    function generarArbol(){
      const codigo = document.getElementById('codigo').value.trim();
      const btn = document.getElementById('verBtn');
      document.getElementById('mensajeError').innerText='';
      document.getElementById('arbolRed').innerHTML='';
      document.getElementById('chipsCont').style.display='none';
      document.getElementById('navButtons').style.display='none';
      if(!codigo){ document.getElementById('mensajeError').innerText='Debes ingresar tu c√≥digo asignado.'; return; }
      btn.disabled=true; const original=btn.innerText; btn.innerText='Buscando...';
      fetch(SHEET_CSV_URL)
        .then(r=>r.text())
        .then(csv=>{
          const filas = csv.split('\n');
          const headers = filas[0].split(',').map(limpiarTexto);
          registros = filas.slice(1).map(row=>{ const cols=row.split(','); const obj={}; headers.forEach((k,i)=>obj[k]=limpiarTexto(cols[i])); return obj; });
          const raiz = getPorCodigo(codigo);
          raizGlobal = raiz;
          initialRoot = raiz;
          historyStack = [];
          if(!raiz){ document.getElementById('mensajeError').innerText='No se encontr√≥ el c√≥digo en la base de datos.'; btn.disabled=false; btn.innerText=original; return; }
          updateTreeView();
          btn.disabled=false; btn.innerText=original;
        })
        .catch(err=>{ console.error(err); document.getElementById('mensajeError').innerText='No se pudo consultar la base de datos.'; btn.disabled=false; btn.innerText=original; });
    }
    function updateTreeView(){
      const raiz = raizGlobal;
      const hijos = buscarPorPatrocinador(raiz['C√≥digo Asignado']);
      const izq   = hijos[0] ? contarPuntosRama(hijos[0],1,MAX_DESC) : 0;
      const der   = hijos[1] ? contarPuntosRama(hijos[1],1,MAX_DESC) : 0;
      const total = izq + der;
      const nivComp  = nivelesCompletos(raiz,1,MAX_DESC);
      const personas = contarRed(raiz,1,MAX_DESC);
      renderChips({ personas, nivComp, izq, der, total });
      nivelesData = construirNiveles([raiz],0,MAX_DESC);
      renderArbol();
      renderNavButtons();
    }
    function renderChips({ personas, nivComp, izq, der, total }){
      const cont = document.getElementById('chipsCont');
      cont.innerHTML = `<span class='chip'>Personas en red: <b>${personas}</b></span><span class='chip'>Niveles completos: <b>${nivComp}</b></span><span class='chip'>Puntos Izq: <b>${izq}</b></span><span class='chip'>Puntos Der: <b>${der}</b></span><span class='chip' id='totalPuntos'>Total puntos: <b>${total}</b></span>`;
      cont.style.display = 'flex';
    }
    function renderArbol(){
      const cont = document.getElementById('arbolRed');
      cont.innerHTML = '';
      const descendantLevels = Math.min(MAX_DESC, nivelesData.length - 1);
      const nivelesAMostrar = descendantLevels + 1;
      for(let i=0; i<nivelesAMostrar; i++){
        const nivelDiv = document.createElement('div');
        nivelDiv.className = 'nivel';
        const fila = document.createElement('div'); fila.className = 'fila';
        nivelesData[i].forEach(nodo => {
          fila.innerHTML += nodo
            ? `<div class='nodo ${i===0? 'raiz': ''}'><div class='nombre'>${nodo.Nombre||''}</div><div class='codigo'>${nodo['C√≥digo Asignado']||''}</div><div class='paq'>${nodo.Paquete||''}</div></div>`
            : `<div class='nodo vacio'>+</div>`;
        });
        nivelDiv.appendChild(fila);
        if(i < nivelesAMostrar - 1){
          const cons = document.createElement('div'); cons.className = 'conectores';
          for(let k=0; k<nivelesData[i].length; k++) cons.innerHTML += '<span></span>';
          nivelDiv.appendChild(cons);
        }
        cont.appendChild(nivelDiv);
      }
      ajustarEscalaGlobal(nivelesAMostrar);
      cont.querySelectorAll('.nodo').forEach(el => {
        if(!el.classList.contains('vacio')){
          el.onclick = () => {
            const codeEl = el.querySelector('.codigo');
            const code = codeEl ? codeEl.innerText : null;
            if(code){
              historyStack.push(raizGlobal['C√≥digo Asignado']);
              const nodo = getPorCodigo(code);
              if(nodo){ raizGlobal = nodo; updateTreeView(); }
            }
          };
        }
      });
    }
    function ajustarEscalaGlobal(nivelesAMostrar){
      const container = document.querySelector('.card');
      const available = container.clientWidth - 32;
      const nodeSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--node'));
      const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap'));
      let maxNodes = 0;
      for(let i=0; i<nivelesAMostrar; i++) maxNodes = Math.max(maxNodes, nivelesData[i].length);
      const required = maxNodes * nodeSize + (maxNodes - 1) * gap;
      let scale = available / required;
      scale = scale > 1 ? 1 : (scale < 0.45 ? 0.45 : scale);
      document.documentElement.style.setProperty('--scale', scale.toString());
    }
    function renderNavButtons(){
      const nav = document.getElementById('navButtons'); nav.innerHTML = '';
      if(historyStack.length > 0){
        const backBtn = document.createElement('button'); backBtn.innerText = '‚Üê Anterior'; backBtn.onclick = goBack;
        const homeBtn = document.createElement('button'); homeBtn.innerText = 'üè† Inicio'; homeBtn.onclick = goHome;
        nav.appendChild(backBtn); nav.appendChild(homeBtn); nav.style.display = 'flex';
      } else {
        nav.style.display = 'none';
      }
    }
    function goBack(){ const prev = historyStack.pop(); if(prev){ const nodo = getPorCodigo(prev); if(nodo){ raizGlobal = nodo; updateTreeView(); } }}
    function goHome(){ raizGlobal = initialRoot; historyStack = []; updateTreeView(); }
    window.addEventListener('resize', ()=>{ if(nivelesData.length) renderArbol(); });
  </script>
</body>
</html>

