<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Así va tu red - Proceso previo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #f1f5f9;
            font-family: 'Inter', Arial, sans-serif;
        }
        .container {
            max-width: 1000px;
            margin: 30px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 6px 32px rgba(60,90,200,0.12);
            padding: 2.5rem 1rem 2.5rem 1rem;
        }
        h1 {
            text-align: center;
            color: #2563eb;
            margin-bottom: 8px;
        }
        .desc {
            text-align: center;
            color: #64748b;
            font-size: 1.09rem;
            margin-bottom: 30px;
        }
        #input-section {
            text-align: center;
            margin-bottom: 22px;
        }
        #codigo {
            font-size: 1.08rem;
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #b6c6e3;
            width: 220px;
            margin-right: 10px;
        }
        button#verArbolBtn {
            background: linear-gradient(90deg, #2563eb 80%, #4ade80 120%);
            color: #fff;
            font-weight: bold;
            padding: 8px 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.04rem;
            transition: background .15s, transform .1s;
        }
        button#verArbolBtn:active { transform: scale(.96);}
        .info-bar {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 18px;
            margin-bottom: 16px;
        }
        .info-box {
            background: #f3f7fd;
            color: #2563eb;
            font-weight: 600;
            border-radius: 10px;
            padding: 8px 22px;
            font-size: 1.07rem;
        }
        .ganancias-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
        }
        .ganancia-box {
            background: #f8fafc;
            border: 1.5px solid #60a5fa;
            border-radius: 12px;
            color: #14b8a6;
            font-weight: 700;
            font-size: 1.12rem;
            padding: 9px 30px;
            text-align: center;
            min-width: 170px;
        }
        .arbol {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all .22s cubic-bezier(.4,1,.6,1);
            margin-top: 16px;
            margin-bottom: 44px;
            width: 100%;
        }
        .nivel {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin: 16px 0;
            width: 100%;
            gap: 18px;
            transition: gap .18s cubic-bezier(.4,1,.6,1);
        }
        /* Ajusta el tamaño de los círculos según niveles */
        .nodo { 
            background: #fff;
            border: 2.3px solid #2563eb;
            border-radius: 50%;
            min-width: 80px; max-width: 86px;
            min-height: 80px; max-height: 86px;
            margin: 0 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.01rem;
            box-shadow: 0 1px 7px #4ade8033;
            position: relative;
            transition: all .18s;
            font-weight: 600;
        }
        .nodo.nivel-4, .nodo.nivel-5 { min-width:60px; max-width:66px; min-height:60px; max-height:66px; font-size:0.95rem;}
        .nodo .nombre { color: #2563eb; font-weight: 700; font-size: 1.04em; margin-bottom: 2px;}
        .nodo .codigo { color: #64748b; font-size: 0.98em; margin-bottom: 2px;}
        .nodo .paquete { font-size: 0.93em; color: #10b981;}
        .nodo.raiz {
            background: linear-gradient(90deg, #2563eb 80%, #4ade80 120%);
            color: #fff; border: 2.3px solid #4ade80;
            box-shadow: 0 4px 18px #4ade8030;
        }
        .nodo.raiz .nombre, .nodo.raiz .codigo, .nodo.raiz .paquete { color: #fff;}
        .nodo.vacio {
            color: #a3a3a3;
            border-style: dashed;
            border-color: #b6c6e3;
            background: #f7fafc;
            font-style: italic;
            font-size: 0.95em;
            font-weight: 400;
        }
        .nodo.vacio .plus { font-size:2rem; color:#bae6fd;}
        /* Botón para mostrar más niveles */
        #toggleNivelesBtn {
            position: fixed;
            bottom: 44px;
            right: 40px;
            background: linear-gradient(90deg,#34d399,#2563eb 90%);
            color: #fff;
            border: none;
            font-weight: 700;
            font-size: 1.08rem;
            border-radius: 24px;
            padding: 15px 32px;
            cursor: pointer;
            box-shadow: 0 2px 14px #1d4ed822;
            z-index: 99;
            transition: background .13s, box-shadow .11s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        #toggleNivelesBtn:active { background: #22d3ee;}
        #mensajeError { color:#e11d48;text-align:center;margin-top:1rem;}
        @media (max-width:900px) {
            .container { max-width:97vw;}
            .nivel { gap: 7px;}
            .nodo, .nodo.nivel-4, .nodo.nivel-5 { min-width:48px; max-width:60px; min-height:48px; max-height:60px; font-size:0.8rem;}
        }
        @media (max-width:600px) {
            .nodo, .nodo.nivel-4, .nodo.nivel-5 { min-width:36px; max-width:48px; min-height:36px; max-height:48px; font-size:0.7rem;}
            .container { padding: 0.7rem;}
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Así va tu red</h1>
        <div class="desc">Proceso previo (antes de inscribirte a Gano Excel)</div>
        <div id="input-section">
            <input type="text" id="codigo" placeholder="Ingresa tu código asignado">
            <button id="verArbolBtn" onclick="generarArbol()">Ver árbol</button>
        </div>
        <div id="infoBar" class="info-bar"></div>
        <div id="gananciasBar" class="ganancias-bar"></div>
        <div id="arbolRed" class="arbol"></div>
        <div id="mensajeError"></div>
    </div>
    <button id="toggleNivelesBtn" style="display:none;" onclick="toggleNiveles()">
        Ver más niveles
        <span id="iconNiveles">▼</span>
    </button>
    <script>
        // URL de tu Google Sheet en CSV (NO TOCAR)
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRusO2GcoYUtkgNYArBk_q8ApISe1IZodp9PoNYDfMVuZ2Vrs8T6InJNLCvOHTj-Mww1sEcGk33EHAR/pub?output=csv';

        let registros = [];
        let maxNivel = 3; // Por defecto solo 3 niveles
        let maxNivelTotal = 5; // Para expandir si lo desea

        function limpiarTexto(text) {
            return (text || '').replace(/"/g, '').trim();
        }

        function puntosPorPaquete(paquete) {
            switch(limpiarTexto(paquete).toUpperCase()) {
                case "ESP 1": return 100;
                case "ESP 2": return 250;
                case "ESP 3": return 500;
                default: return 0;
            }
        }

        function buscarPorPatrocinador(patrocinador) {
            return registros.filter(x => limpiarTexto(x.Patrocinador) === limpiarTexto(patrocinador)).slice(0, 2);
        }

        function getPorCodigo(codigo) {
            return registros.find(x => limpiarTexto(x['Código Asignado']) === limpiarTexto(codigo));
        }

        function contarRed(nodo, nivel, maxNivelMostrar) {
            if (!nodo || nivel > maxNivelMostrar) return 0;
            let hijos = buscarPorPatrocinador(nodo['Código Asignado']);
            let total = hijos.length;
            for (let h of hijos) {
                total += contarRed(h, nivel + 1, maxNivelMostrar);
            }
            return total;
        }

        function nivelesCompletos(nodo, nivel, maxNivelMostrar) {
            if (!nodo || nivel > maxNivelMostrar) return nivel-1;
            let hijos = buscarPorPatrocinador(nodo['Código Asignado']);
            if (hijos.length < 2) return nivel-1;
            return Math.min(
                nivelesCompletos(hijos[0], nivel+1, maxNivelMostrar),
                nivelesCompletos(hijos[1], nivel+1, maxNivelMostrar)
            );
        }

        // Puntos por rama y paquete (para cálculo binario)
        function sumarPuntosRama(nodo, nivel, maxNivelMostrar) {
            if (!nodo || nivel > maxNivelMostrar) return 0;
            let hijos = buscarPorPatrocinador(nodo['Código Asignado']);
            let total = puntosPorPaquete(nodo.Paquete);
            for (let h of hijos) {
                total += sumarPuntosRama(h, nivel + 1, maxNivelMostrar);
            }
            return total;
        }

        // Bonos directos: solo los del primer nivel
        function bonosDirectos(nodo) {
            let hijos = buscarPorPatrocinador(nodo['Código Asignado']);
            let total = 0;
            hijos.forEach(hijo => {
                switch ((hijo.Paquete||"").toUpperCase()) {
                    case "ESP 1": total += 112500; break;
                    case "ESP 2": total += 337500; break;
                    case "ESP 3": total += 675000; break;
                }
            });
            return total;
        }

        // Bonos generacionales (solo segundo nivel, ejemplo)
        function bonosGeneracionales(nodo, nivel, maxNivelMostrar) {
            if (!nodo || nivel > maxNivelMostrar) return 0;
            let hijos = buscarPorPatrocinador(nodo['Código Asignado']);
            let total = 0;
            if (nivel >= 2) {
                hijos.forEach(hijo => {
                    switch ((hijo.Paquete||"").toUpperCase()) {
                        case "ESP 1": total += 22500; break;
                        case "ESP 2": total += 45000; break;
                        case "ESP 3": total += 90000; break;
                    }
                });
            }
            hijos.forEach(hijo => {
                total += bonosGeneracionales(hijo, nivel + 1, maxNivelMostrar);
            });
            return total;
        }

        // Porcentaje binario según tu propio paquete
        function porcBinario(paquete) {
            switch((paquete||"").toUpperCase()) {
                case "ESP 1": return 0.10;
                case "ESP 2": return 0.15;
                case "ESP 3": return 0.17;
                default: return 0;
            }
        }

        function calcularBinario(paqPropio, puntosIzq, puntosDer) {
            // Aplica compensación: solo suma por la pierna más corta, y descuenta de la larga
            let menor = Math.min(puntosIzq, puntosDer);
            return Math.round((menor * 4500 * porcBinario(paqPropio)) * 100) / 100;
        }

        function calcularArbol(codigo, nivelVisible) {
            // Se encarga de todos los cálculos y del render
            const raiz = getPorCodigo(codigo);
            if (!raiz) {
                document.getElementById('arbolRed').innerHTML = "";
                document.getElementById('infoBar').innerHTML = "";
                document.getElementById('gananciasBar').innerHTML = "";
                document.getElementById('mensajeError').innerText = "No se encontró el código en la base de datos.";
                document.getElementById('toggleNivelesBtn').style.display = "none";
                return;
            }
            document.getElementById('mensajeError').innerText = "";

            // Calcula puntos de cada rama
            let hijos = buscarPorPatrocinador(raiz['Código Asignado']);
            let izq = hijos[0] ? sumarPuntosRama(hijos[0], 1, nivelVisible) : 0;
            let der = hijos[1] ? sumarPuntosRama(hijos[1], 1, nivelVisible) : 0;
            let totalPuntos = izq + der;

            // Info superior (red)
            document.getElementById('infoBar').innerHTML = `
                <div class="info-box">Personas en red: <b>${contarRed(raiz, 1, nivelVisible)}</b></div>
                <div class="info-box">Niveles completos: <b>${nivelesCompletos(raiz, 1, nivelVisible)}</b></div>
                <div class="info-box">Puntos izquierda: <b>${izq}</b></div>
                <div class="info-box">Puntos derecha: <b>${der}</b></div>
                <div class="info-box">Total puntos: <b>${totalPuntos}</b></div>
            `;

            // Ganancias (solo reales, no simulador)
            let binario = calcularBinario(raiz.Paquete, izq, der);
            let bonosDir = bonosDirectos(raiz)/4500;
            let bonosGen = bonosGeneracionales(raiz, 1, nivelVisible)/4500;

            document.getElementById('gananciasBar').innerHTML = `
                <div class="ganancia-box">Ganancia binaria: <br><span style="color:#2563eb">$${binario.toFixed(2)} USD</span></div>
                <div class="ganancia-box">Bonos directos: <br><span style="color:#2563eb">$${bonosDir.toFixed(2)} USD</span></div>
                <div class="ganancia-box">Bonos generacionales: <br><span style="color:#2563eb">$${bonosGen.toFixed(2)} USD</span></div>
                <div class="ganancia-box" style="border-color:#22d3ee;">Total: <br><span style="color:#059669">$${(binario+bonosDir+bonosGen).toFixed(2)} USD</span></div>
            `;

            // Árbol visual dinámico
            document.getElementById('arbolRed').innerHTML = crearNivelHTML([raiz], 1, nivelVisible);
            // Mostrar u ocultar botón
            if (maxNivel === 3 && contarRed(raiz, 1, 4) > 0) {
                document.getElementById('toggleNivelesBtn').style.display = "flex";
                document.getElementById('iconNiveles').innerText = "▼";
                document.getElementById('toggleNivelesBtn').innerHTML = `Ver más niveles <span id="iconNiveles">▼</span>`;
            } else if (maxNivel === 5) {
                document.getElementById('toggleNivelesBtn').style.display = "flex";
                document.getElementById('iconNiveles').innerText = "▲";
                document.getElementById('toggleNivelesBtn').innerHTML = `Ver menos niveles <span id="iconNiveles">▲</span>`;
            } else {
                document.getElementById('toggleNivelesBtn').style.display = "none";
            }
        }

        // Dibuja solo los nodos que existen y los de “Patrocinar aquí”
        function crearNivelHTML(nodos, nivel, maxNivelMostrar) {
            if (nivel > maxNivelMostrar) return "";
            let html = `<div class="nivel">`;
            let siguientes = [];
            nodos.forEach(nodo => {
                if (!nodo) return;
                html += `<div class="nodo ${nivel === 1 ? "raiz" : ""} nivel-${nivel}">
                    <div class="nombre">${nodo.Nombre || 'Sin nombre'}</div>
                    <div class="codigo">${nodo['Código Asignado']}</div>
                    <div class="paquete">${nodo.Paquete ? nodo.Paquete : ''}</div>
                </div>`;
                // hijos
                let hijos = buscarPorPatrocinador(nodo['Código Asignado']);
                // Solo agrega "Patrocinar aquí" si hay cupos en binario
                if (nivel < maxNivelMostrar) {
                    if (hijos.length === 0) {
                        siguientes.push(null, null);
                        html += `<div class="nodo vacio nivel-${nivel+1}"><span class="plus">+</span></div>`;
                        html += `<div class="nodo vacio nivel-${nivel+1}"><span class="plus">+</span></div>`;
                    } else if (hijos.length === 1) {
                        siguientes.push(hijos[0], null);
                        html += crearNivelHTML([hijos[0]], nivel + 1, maxNivelMostrar);
                        html += `<div class="nodo vacio nivel-${nivel+1}"><span class="plus">+</span></div>`;
                    } else if (hijos.length === 2) {
                        siguientes.push(hijos[0], hijos[1]);
                        // nada extra, los hijos reales se procesan
                    }
                }
            });
            html += `</div>`;
            if (nivel < maxNivelMostrar && siguientes.length > 0 && nodos.some(n=>n)) {
                html += crearNivelHTML(siguientes, nivel + 1, maxNivelMostrar);
            }
            return html;
        }

        // Eventos principales
        function generarArbol() {
            let codigo = document.getElementById('codigo').value.trim();
            if (!codigo) {
                document.getElementById('mensajeError').innerText = "Debes ingresar tu código asignado.";
                return;
            }
            document.getElementById('mensajeError').innerText = "";
            fetch(SHEET_CSV_URL)
                .then(r => r.text())
                .then(csv => {
                    const filas = csv.split('\n');
                    const encabezados = filas[0].split(',').map(x => limpiarTexto(x));
                    registros = filas.slice(1).map(f => {
                        const cols = f.split(',');
                        let obj = {};
                        encabezados.forEach((k, i) => obj[k] = limpiarTexto(cols[i]));
                        return obj;
                    });
                    maxNivel = 3;
                    calcularArbol(codigo, maxNivel);
                })
                .catch(err => {
                    document.getElementById('mensajeError').innerText = "No se pudo consultar la base de datos.";
                });
        }

        function toggleNiveles() {
            maxNivel = (maxNivel === 3) ? 5 : 3;
            let codigo = document.getElementById('codigo').value.trim();
            if (codigo && registros.length > 0) {
                calcularArbol(codigo, maxNivel);
            }
        }
    </script>
</body>
</html>

