<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Red de Acci√≥n Masiva - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.349.0/dist/lucide.css" />
  <style>
    :root {
      --primary: #2563eb;
      --accent: #22c55e;
      --sidebar: #0f172a;
      --sidebar-active: #2563eb;
      --bg: linear-gradient(135deg, #e3ebfd 0%, #f6fcff 100%);
      --card-bg: rgba(255,255,255,0.92);
      --glass: rgba(255,255,255,0.60);
      --surface: #ffffff;
      --chip-bg: #e0f2fe;
      --chip-color: #2563eb;
      --success-bg: #e2fbe2;
      --success-txt: #15803d;
      --shadow: 0 8px 32px rgba(37,99,235,0.12);
      --radius: 20px;
      --node: 92px;
      --gap: 24px;
      --transition: 0.17s cubic-bezier(.7,.22,.17,.89);
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Inter', Arial, sans-serif;
      background: var(--bg);
      color: #23272f;
    }
    body {
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
    }
    /* Sidebar */
    .sidebar {
      background: var(--sidebar);
      color: #fff;
      width: 210px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 32px 0 24px 0;
      box-shadow: 0 0 30px rgba(30,41,59,0.13);
      position: relative;
    }
    .sidebar .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Montserrat', sans-serif;
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 42px;
      letter-spacing: 1.5px;
      gap: 12px;
      color: var(--primary);
    }
    .sidebar .logo::before {
      content: '';
      display: block;
      width: 32px; height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      box-shadow: 0 4px 14px rgba(34,197,94,.12);
    }
    .sidebar nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .sidebar nav a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 11px 32px;
      text-decoration: none;
      color: #cbd5e1;
      font-weight: 500;
      border-left: 4px solid transparent;
      transition: background var(--transition), color var(--transition), border-color var(--transition);
      border-radius: 0 22px 22px 0;
    }
    .sidebar nav a.active, .sidebar nav a:hover {
      background: rgba(37,99,235,0.09);
      color: #fff;
      border-color: var(--sidebar-active);
    }
    .sidebar .logout {
      margin: 32px 0 0 0;
      display: flex; justify-content: center;
    }
    .sidebar .logout button {
      background: none; border: none; color: #94a3b8;
      font-size: 1.05rem; cursor: pointer;
      display: flex; align-items: center; gap: 7px;
      transition: color 0.18s;
    }
    .sidebar .logout button:hover { color: #fff; }
    /* Main section */
    .dashboard-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .main-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 26px 44px 18px 44px;
      border-bottom: 1.5px solid #f1f5f9;
      background: var(--glass);
      box-shadow: 0 2px 18px rgba(30,64,175,0.05);
      position: sticky;
      top: 0;
      z-index: 22;
      backdrop-filter: blur(6px);
    }
    .main-header .title {
      font-family: 'Montserrat',sans-serif;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--primary);
    }
    /* M√©tricas */
    .metrics-row {
      display: flex;
      gap: 32px;
      margin: 38px 0 16px 0;
      justify-content: flex-start;
      flex-wrap: wrap;
      padding: 0 44px;
    }
    .metric-card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 22px 32px 18px 28px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 178px;
      max-width: 210px;
      position: relative;
      transition: transform .11s;
    }
    .metric-card:hover {
      transform: translateY(-4px) scale(1.032);
      box-shadow: 0 16px 40px rgba(37,99,235,0.16);
    }
    .metric-title {
      font-size: 1.05rem;
      font-weight: 600;
      opacity: .76;
      margin-bottom: 3px;
      display: flex; align-items: center; gap: 8px;
    }
    .metric-value {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: .5px;
      margin-bottom: 3px;
      line-height: 1.15;
    }
    .metric-card.total { background: var(--success-bg); color: var(--success-txt);}
    .metric-card.total .metric-value { color: var(--success-txt);}
    /* Buscador */
    .search-box {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .search-box input {
      font-size: 1.1rem;
      padding: 9px 14px;
      border-radius: 9px;
      border: 1.2px solid #cdd4e1;
      background: #f5faff;
      outline: none;
      transition: border .13s;
      width: 170px;
    }
    .search-box button {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 9px;
      font-weight: 700;
      padding: 9px 20px;
      font-size: 1.07rem;
      cursor: pointer;
      transition: background .12s;
    }
    .search-box button:active { background: #1d4ed8; }
    .search-box button[disabled] { opacity: .62; cursor: not-allowed;}
    /* Glass card */
    .glass-card {
      width: 99%;
      max-width: 1200px;
      background: var(--card-bg);
      margin: 0 auto;
      margin-top: 18px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 32px 18px 42px 18px;
      min-height: 370px;
      position: relative;
      transition: box-shadow .11s;
      backdrop-filter: blur(7px);
      overflow-x: auto;
    }
    /* Chips arriba del √°rbol */
    .chips {
      display: flex; flex-wrap: wrap; justify-content: flex-start; gap: 13px;
      margin-bottom: 16px;
    }
    .chip {
      background: var(--chip-bg);
      color: var(--chip-color);
      padding: 7px 18px;
      border-radius: 999px;
      font-size: .98rem;
      font-weight: 600;
      white-space: nowrap;
      box-shadow: 0 2px 10px rgba(34,197,94,0.07);
    }
    #totalPuntos { background: #e2fbe2; color: #15803d; }
    /* √Årbol binario */
    .arbol {
      display: flex; flex-direction: column; align-items: center;
      width: 100%;
      margin-top: 10px;
      --current-scale: var(--scale,1);
    }
    .nivel {
      position: relative;
      transform-origin: top center;
      margin: 16px 0;
      transform: scaleX(var(--current-scale)) scaleY(1);
    }
    .fila {
      display: flex; justify-content: center; gap: var(--gap);
    }
    .nodo {
      width: var(--node);
      height: var(--node);
      border-radius: 50%;
      border: 2.6px solid var(--primary);
      background: #fff;
      box-shadow: 0 4px 16px rgba(37,99,235,0.16);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      text-align: center; padding: 4px;
      font-size: .82rem; color: var(--primary);
      transition: box-shadow .13s, border-color .12s, background .12s;
      cursor: pointer;
      font-family: 'Montserrat',sans-serif;
      position: relative;
      overflow: hidden;
    }
    .nodo:hover {
      box-shadow: 0 10px 24px rgba(37,99,235,0.29);
      background: #f1f5fe;
      border-color: #0ea5e9;
      z-index: 2;
    }
    .nodo.raiz {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-color: var(--accent);
      color: #fff;
      box-shadow: 0 16px 32px rgba(34,197,94,.25);
      font-size: .93rem;
      font-weight: bold;
      text-shadow: 0 2px 10px rgba(37,99,235,0.17);
    }
    .nodo .nombre { font-weight: 700; line-height: 1.05; margin-bottom: 2px; }
    .nodo .codigo { font-size: .72rem; opacity: .87; }
    .nodo .paq { font-size: .74rem; color: #0ea5e9; }
    .vacio {
      border-style: dashed; border-color: #93c5fd;
      background: #f1f5fe; color: #93c5fd;
      font-size: 1.7rem; line-height: calc(var(--node) - 4px);
      cursor: default !important;
      pointer-events: none;
    }
    .conectores {
      display: flex; justify-content: center;
      gap: calc(var(--gap) + var(--node) - 46px);
      height: 16px; margin-top: 6px;
    }
    .conectores span {
      display: block; width: 46px; border-bottom: 2.2px solid #cbd5e1;
    }
    /* Navegaci√≥n √°rbol */
    .nav-buttons {
      display: flex;
      gap: 9px;
      margin-bottom: 17px;
    }
    .nav-buttons button {
      background: var(--surface);
      border: 1.5px solid var(--primary);
      color: var(--primary);
      padding: 8px 17px;
      border-radius: 8px;
      font-size: .98rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .12s, color .13s, border-color .12s;
    }
    .nav-buttons button:hover {
      background: var(--primary);
      color: #fff;
      border-color: #0ea5e9;
    }
    /* Error */
    #mensajeError {
      color: #e11d48;
      margin-top: 13px;
      text-align: center;
      min-height: 20px;
    }
    /* Responsive */
    @media (max-width: 1100px) {
      .metrics-row { gap: 16px; }
      .main-header, .metrics-row { padding-left: 22px; padding-right: 22px;}
    }
    @media (max-width:900px) {
      .sidebar { width: 60px; min-width: 60px;}
      .sidebar .logo { font-size: 0; }
      .sidebar .logo::before { width: 24px; height: 24px;}
      .sidebar nav a span, .sidebar .logout span { display: none;}
      .sidebar nav a { padding: 11px 9px;}
    }
    @media (max-width:800px) {
      .metrics-row { flex-wrap: wrap; }
      .main-header, .metrics-row { padding-left: 6px; padding-right: 6px;}
      .glass-card { padding-left: 2vw; padding-right: 2vw;}
    }
    @media (max-width:600px) {
      .glass-card { min-width: 98vw; }
      .nodo { font-size: .73rem; }
      .chips { font-size: .93rem;}
      .main-header { font-size: .91rem;}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">Red Acci√≥n <span></span></div>
    <nav>
      <a class="active" href="#"><i class="lucide lucide-network"></i><span>Dashboard</span></a>
      <a href="#"><i class="lucide lucide-bar-chart"></i><span>M√©tricas</span></a>
      <a href="#"><i class="lucide lucide-users"></i><span>Red</span></a>
      <a href="#"><i class="lucide lucide-list"></i><span>Registros</span></a>
      <a href="#"><i class="lucide lucide-settings"></i><span>Configuraci√≥n</span></a>
    </nav>
    <div class="logout">
      <button><i class="lucide lucide-log-out"></i><span>Salir</span></button>
    </div>
  </aside>
  <!-- Main dashboard -->
  <section class="dashboard-content">
    <div class="main-header">
      <span class="title">As√≠ va tu red</span>
      <div class="search-box">
        <input type="text" id="codigo" placeholder="RM-0000" />
        <button id="verBtn" onclick="generarArbol()">Ver √°rbol</button>
      </div>
    </div>
    <!-- M√©tricas tipo cards -->
    <div class="metrics-row">
      <div class="metric-card">
        <span class="metric-title"><i class="lucide lucide-users"></i>Personas en red</span>
        <span class="metric-value" id="metric-personas">-</span>
      </div>
      <div class="metric-card">
        <span class="metric-title"><i class="lucide lucide-bar-chart"></i>Niveles completos</span>
        <span class="metric-value" id="metric-niveles">-</span>
      </div>
      <div class="metric-card">
        <span class="metric-title"><i class="lucide lucide-arrow-left"></i>Puntos Izq</span>
        <span class="metric-value" id="metric-izq">-</span>
      </div>
      <div class="metric-card">
        <span class="metric-title"><i class="lucide lucide-arrow-right"></i>Puntos Der</span>
        <span class="metric-value" id="metric-der">-</span>
      </div>
      <div class="metric-card total">
        <span class="metric-title"><i class="lucide lucide-trophy"></i>Total puntos</span>
        <span class="metric-value" id="metric-total">-</span>
      </div>
    </div>
    <!-- Glass card central -->
    <div class="glass-card">
      <div id="navButtons" class="nav-buttons"></div>
      <div id="chipsCont" class="chips" style="display:none;"></div>
      <div id="arbolRed" class="arbol"></div>
      <div id="mensajeError"></div>
    </div>
  </section>
  <!-- JS l√≥gic√° √°rbol, deja tu c√≥digo JS aqu√≠ (NO cambies funcionamiento, solo los ID de m√©tricas y HTML siguen igual que tu versi√≥n previa) -->
  <script>
    // Tu JS actual, solo cambia chips/IDs m√©tricas para actualizar tarjetas
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRusO2GcoYUtkgNYArBk_q8ApISe1IZodp9PoNYDfMVuZ2Vrs8T6InJNLCvOHTj-Mww1sEcGk33EHAR/pub?output=csv';
    let registros = [], nivelesData = [], raizGlobal = null, initialRoot = null, historyStack = [];
    const MAX_DESC = 3;
    const limpiarTexto = t => (t||'').replace(/\"/g,'').trim();
    function buscarPorPatrocinador(p){ return registros.filter(x=>limpiarTexto(x.Patrocinador)===limpiarTexto(p)).slice(0,2); }
    function getPorCodigo(c){ return registros.find(x=>limpiarTexto(x['C√≥digo Asignado'])===limpiarTexto(c)); }
    function puntosPorPaquete(p){ switch(limpiarTexto(p).toUpperCase()){ case 'ESP 1': return 100; case 'ESP 2': return 250; case 'ESP 3': return 500; default: return 0; } }
    function contarPuntosRama(nodo,nivel,maxNivel){ if(!nodo||nivel>maxNivel) return 0; const hijos = buscarPorPatrocinador(nodo['C√≥digo Asignado']); let total = puntosPorPaquete(nodo.Paquete); for(const h of hijos) total += contarPuntosRama(h,nivel+1,maxNivel); return total; }
    function contarRed(nodo,nivel,maxNivel){ if(!nodo||nivel>maxNivel) return 0; const hijos = buscarPorPatrocinador(nodo['C√≥digo Asignado']); let total = hijos.length; for(const h of hijos) total += contarRed(h,nivel+1,maxNivel); return total; }
    function nivelesCompletos(nodo,nivel,maxNivel){ if(!nodo||nivel>maxNivel) return nivel-1; const hijos = buscarPorPatrocinador(nodo['C√≥digo Asignado']); if(hijos.length<2) return nivel-1; return Math.min(nivelesCompletos(hijos[0],nivel+1,maxNivel), nivelesCompletos(hijos[1],nivel+1,maxNivel)); }
    function construirNiveles(nodos, lvlActual, maxDesc){ const niveles=[]; (function rec(actual,lvl){ niveles.push([...actual]); if(lvl===maxDesc) return; const siguiente=[]; actual.forEach(n => { if(!n){ siguiente.push(null,null); } else { const h = buscarPorPatrocinador(n['C√≥digo Asignado']); siguiente.push(h[0]||null,h[1]||null); } }); rec(siguiente,lvl+1); })(nodos,lvlActual); return niveles; }
    function generarArbol(){
      const codigo = document.getElementById('codigo').value.trim();
      const btn = document.getElementById('verBtn');
      document.getElementById('mensajeError').innerText='';
      document.getElementById('arbolRed').innerHTML='';
      document.getElementById('chipsCont').style.display='none';
      document.getElementById('navButtons').style.display='none';
      if(!codigo){ document.getElementById('mensajeError').innerText='Debes ingresar tu c√≥digo asignado.'; return; }
      btn.disabled=true; const original=btn.innerText; btn.innerText='Buscando...';
      fetch(SHEET_CSV_URL)
        .then(r=>r.text())
        .then(csv=>{
          const filas = csv.split('\n');
          const headers = filas[0].split(',').map(limpiarTexto);
          registros = filas.slice(1).map(row=>{ const cols=row.split(','); const obj={}; headers.forEach((k,i)=>obj[k]=limpiarTexto(cols[i])); return obj; });
          const raiz = getPorCodigo(codigo);
          raizGlobal = raiz;
          initialRoot = raiz;
          historyStack = [];
          if(!raiz){ document.getElementById('mensajeError').innerText='No se encontr√≥ el c√≥digo en la base de datos.'; btn.disabled=false; btn.innerText=original; return; }
          updateTreeView();
          btn.disabled=false; btn.innerText=original;
        })
        .catch(err=>{ console.error(err); document.getElementById('mensajeError').innerText='No se pudo consultar la base de datos.'; btn.disabled=false; btn.innerText=original; });
    }
    function updateTreeView(){
      const raiz = raizGlobal;
      const hijos = buscarPorPatrocinador(raiz['C√≥digo Asignado']);
      const izq   = hijos[0] ? contarPuntosRama(hijos[0],1,MAX_DESC) : 0;
      const der   = hijos[1] ? contarPuntosRama(hijos[1],1,MAX_DESC) : 0;
      const total = izq + der;
      const nivComp  = nivelesCompletos(raiz,1,MAX_DESC);
      const personas = contarRed(raiz,1,MAX_DESC);
      // Actualiza m√©tricas cards
      document.getElementById('metric-personas').textContent = personas;
      document.getElementById('metric-niveles').textContent = nivComp;
      document.getElementById('metric-izq').textContent = izq;
      document.getElementById('metric-der').textContent = der;
      document.getElementById('metric-total').textContent = total;
      renderChips({ personas, nivComp, izq, der, total });
      nivelesData = construirNiveles([raiz],0,MAX_DESC);
      renderArbol();
      renderNavButtons();
    }
    function renderChips({ personas, nivComp, izq, der, total }){
      const cont = document.getElementById('chipsCont');
      cont.innerHTML = `<span class='chip'>Personas en red: <b>${personas}</b></span><span class='chip'>Niveles completos: <b>${nivComp}</b></span><span class='chip'>Puntos Izq: <b>${izq}</b></span><span class='chip'>Puntos Der: <b>${der}</b></span><span class='chip' id='totalPuntos'>Total puntos: <b>${total}</b></span>`;
      cont.style.display = 'flex';
    }
    function renderArbol(){
      const cont = document.getElementById('arbolRed');
      cont.innerHTML = '';
      const descendantLevels = Math.min(MAX_DESC, nivelesData.length - 1);
      const nivelesAMostrar = descendantLevels + 1;
      for(let i=0; i<nivelesAMostrar; i++){
        const nivelDiv = document.createElement('div');
        nivelDiv.className = 'nivel';
        const fila = document.createElement('div'); fila.className = 'fila';
        nivelesData[i].forEach(nodo => {
          fila.innerHTML += nodo
            ? `<div class='nodo ${i===0? 'raiz': ''}'><div class='nombre'>${nodo.Nombre||''}</div><div class='codigo'>${nodo['C√≥digo Asignado']||''}</div><div class='paq'>${nodo.Paquete||''}</div></div>`
            : `<div class='nodo vacio'>+</div>`;
        });
        nivelDiv.appendChild(fila);
        if(i < nivelesAMostrar - 1){
          const cons = document.createElement('div'); cons.className = 'conectores';
          for(let k=0; k<nivelesData[i].length; k++) cons.innerHTML += '<span></span>';
          nivelDiv.appendChild(cons);
        }
        cont.appendChild(nivelDiv);
      }
      ajustarEscalaGlobal(nivelesAMostrar);
      cont.querySelectorAll('.nodo').forEach(el => {
        if(!el.classList.contains('vacio')){
          el.onclick = () => {
            const codeEl = el.querySelector('.codigo');
            const code = codeEl ? codeEl.innerText : null;
            if(code){
              historyStack.push(raizGlobal['C√≥digo Asignado']);
              const nodo = getPorCodigo(code);
              if(nodo){ raizGlobal = nodo; updateTreeView(); }
            }
          };
        }
      });
    }
    function ajustarEscalaGlobal(nivelesAMostrar){
      const container = document.querySelector('.glass-card');
      const available = container.clientWidth - 32;
      const nodeSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--node'));
      const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap'));
      let maxNodes = 0;
      for(let i=0; i<nivelesAMostrar; i++) maxNodes = Math.max(maxNodes, nivelesData[i].length);
      const required = maxNodes * nodeSize + (maxNodes - 1) * gap;
      let scale = available / required;
      scale = scale > 1 ? 1 : (scale < 0.45 ? 0.45 : scale);
      document.documentElement.style.setProperty('--scale', scale.toString());
    }
    function renderNavButtons(){
      const nav = document.getElementById('navButtons'); nav.innerHTML = '';
      if(historyStack.length > 0){
        const backBtn = document.createElement('button'); backBtn.innerText = '‚Üê Anterior'; backBtn.onclick = goBack;
        const homeBtn = document.createElement('button'); homeBtn.innerText = 'üè† Inicio'; homeBtn.onclick = goHome;
        nav.appendChild(backBtn); nav.appendChild(homeBtn); nav.style.display = 'flex';
      } else {
        nav.style.display = 'none';
      }
    }
    function goBack(){ const prev = historyStack.pop(); if(prev){ const nodo = getPorCodigo(prev); if(nodo){ raizGlobal = nodo; updateTreeView(); } }}
    function goHome(){ raizGlobal = initialRoot; historyStack = []; updateTreeView(); }
    window.addEventListener('resize', ()=>{ if(nivelesData.length) renderArbol(); });
  </script>
  <!-- Lucide Icons -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.349.0/dist/umd/lucide.min.js"></script>
  <script>
    window.addEventListener("DOMContentLoaded",()=>{ lucide.createIcons(); });
  </script>
</body>
</html>
