<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Red de Acción Masiva | Preinscripción</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.349.0/dist/lucide.css" />
  <style>
    :root{
      --primary:#2563eb;
      --primary-dark:#1d4ed8;
      --accent:#22c55e;
      --sidebar:#0f172a;
      --bg:linear-gradient(135deg,#ecf0fa 0%,#f5fbff 100%);
      --card-bg:#f8faff;
      --surface:#fff;
      --text:#0f172a;
      --text-light:#64748b;
      --error:#e11d48;
      --radius:28px;
      --radius-md:20px;
      --radius-sm:14px;
      --shadow-neu:8px 8px 16px #dde5f0,-8px -8px 18px #fff;
      --shadow-soft:0 8px 24px 0 #dde8fc,0 1.5px 0 #fff inset,0 0.5px 2.5px #b9c6d8 inset;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{height:100%;scroll-behavior:smooth;}
    body{
      font-family:'Inter',Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
      min-height:100vh;
      display:flex;flex-direction:column;
    }
    /* NAVBAR */
    .navbar{
      background:var(--sidebar);
      box-shadow:var(--shadow-soft);
      padding:0.9rem 2.2rem;
      display:flex;align-items:center;justify-content:flex-start;
      position:sticky;top:0;z-index:30;border-radius:0 0 var(--radius) var(--radius);
    }
    .brand{
      font-family:'Montserrat',sans-serif;font-size:1.38rem;font-weight:700;color:var(--primary);
      display:flex;align-items:center;gap:13px;text-decoration:none;
    }
    .brand::before{
      content:"";width:32px;height:32px;border-radius:50%;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      display:inline-block;box-shadow:0 4px 18px #dde8fc,0 0 0 4px #fff;
    }
    /* HERO */
    .hero{
      width:100%;
      background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 60%,#0ea5e9 120%);
      color:#fff;padding:3.5rem 1.2rem 4.2rem;text-align:center;
    }
    .hero h1{
      font-family:'Montserrat',sans-serif;font-size:2.2rem;font-weight:700;margin-bottom:.6rem;
      letter-spacing:1px;text-shadow:0 2px 10px #1d4ed833;
    }
    .hero p{font-size:1.09rem;opacity:.93;max-width:680px;margin:0 auto;font-weight:500;}
    /* FORM WRAPPER */
    .wrapper{flex:1;display:flex;justify-content:center;padding:0 1.2vw;transform:translateY(-60px);margin-bottom:-60px;}
    .card{
      width:100%;max-width:470px;background:var(--card-bg);border-radius:var(--radius);
      box-shadow:var(--shadow-neu);padding:2.4rem 2rem 2.6rem;border:1.8px solid #eef3fb;
      display:flex;flex-direction:column;align-items:center;transition:box-shadow .14s;backdrop-filter:blur(7px);
    }
    .card h2{font-family:'Montserrat',sans-serif;color:var(--primary);font-size:1.6rem;margin-bottom:1.4rem;text-align:center;font-weight:700;letter-spacing:.2px;}
    label{font-size:.97rem;font-weight:600;color:var(--text);margin-bottom:4px;margin-top:5px;display:block;letter-spacing:.01em;}
    input[type="text"],input[type="tel"],select{
      width:100%;padding:11px 12px;border:1.6px solid #cbd5e1;border-radius:12px;font-size:1.02rem;background:#f8fafc;
      transition:border .2s,box-shadow .2s;margin-bottom:17px;outline:none;font-family:'Inter',Arial,sans-serif;
    }
    input:focus,select:focus{border-color:var(--primary-dark);box-shadow:0 0 0 2px #2563eb22;background:#fff;}
    .hint{font-size:.88rem;color:#64748b;margin:-10px 0 12px;}
    button[type="submit"]{
      width:100%;padding:13px 0;border:none;border-radius:14px;background:linear-gradient(90deg,var(--primary) 10%,var(--accent) 140%);
      color:#fff;font-size:1.09rem;font-weight:700;cursor:pointer;box-shadow:0 4px 16px #22c55e44;
      transition:transform .12s,box-shadow .15s,opacity .15s;margin-top:5px;letter-spacing:.2px;
    }
    button[type="submit"]:hover{box-shadow:0 6px 24px #22c55e45;transform:translateY(-1px) scale(1.011);}
    button[type="submit"]:active{transform:scale(.97);box-shadow:0 3px 12px #22c55e33;}
    button[disabled]{opacity:.65;cursor:not-allowed;}
    #msgError{color:var(--error);margin-bottom:10px;font-size:.98rem;text-align:center;min-height:18px;font-weight:600;}
    .muted{color:#64748b;font-size:.92rem;text-align:center;margin-top:6px;}
    /* ÉXITO */
    #codigoGenerado{display:none;margin-top:1.6rem;text-align:center;}
    #codigoGenerado h3{color:var(--primary);margin-bottom:.5rem;font-size:1.35rem;}
    #codigo{font-size:2.1rem;font-weight:700;color:var(--accent);margin-top:.7rem;letter-spacing:1px;}
    .ok-icon{font-size:2.3rem;color:var(--accent);margin-bottom:.6rem;}
    footer{
      width:100%;background:var(--card-bg);color:#94a3b8;text-align:center;font-size:1.04rem;
      padding:18px 0 14px;letter-spacing:.2px;border-top:1.5px solid #e6ecf5;box-shadow:0 -4px 20px #dde8fc2c;border-radius:22px 22px 0 0;z-index:100;margin-top:40px;
    }
    footer a{color:var(--primary);text-decoration:none;}
    @media (max-width:600px){
      .hero h1{font-size:1.7rem;}
      .card{padding:1.3rem .8rem 1.7rem;}
      .brand{font-size:1.04rem;}
      .navbar{padding:1.1rem 1vw;}
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="navbar">
    <a class="brand" href="#">Red de Acción Masiva</a>
  </header>

  <!-- HERO -->
  <section class="hero">
    <h1>Preinscripción a la Red</h1>
    <p>Da el primer paso. Regístrate con tus datos y el código de tu patrocinador para reservar tu lugar.</p>
  </section>

  <!-- FORM -->
  <main class="wrapper">
    <div class="card" id="formCard">
      <h2>Formulario de Preinscripción</h2>
      <div id="msgError"></div>

      <form id="preForm" autocomplete="off">
        <label for="nombre">Nombre completo</label>
        <input type="text" id="nombre" name="nombre" required placeholder="Ej: Juan Pérez">

        <label for="telefono">Teléfono (WhatsApp)</label>
        <input type="tel" id="telefono" name="telefono" required pattern="[0-9]{7,15}" placeholder="Ej: 3121234567">
        <div class="hint">Usa solo números, sin espacios ni signos.</div>

        <label for="patrocinador">Código de tu patrocinador</label>
        <input type="text" id="patrocinador" name="patrocinador" required placeholder="Ej: RM-1234">
        <div class="hint">Formato sugerido: <b>RM-####</b></div>

        <label for="pais">País</label>
        <select id="pais" name="pais" required>
          <option value="">Selecciona tu país</option>
          <option>Argentina</option><option>Bolivia</option><option>Brasil</option><option>Chile</option>
          <option>Colombia</option><option>Costa Rica</option><option>Ecuador</option><option>El Salvador</option>
          <option>Estados Unidos</option><option>Guatemala</option><option>Honduras</option><option>México</option>
          <option>Nicaragua</option><option>Panamá</option><option>Paraguay</option><option>Perú</option>
          <option>Puerto Rico</option><option>República Dominicana</option><option>Uruguay</option><option>Venezuela</option>
        </select>

        <label for="paquete">¿Con qué paquete vas a hacer la inscripción?</label>
        <select id="paquete" name="paquete" required>
          <option value="">Selecciona un paquete</option>
          <option value="ESP 1|100">ESP 1 (100 puntos)</option>
          <option value="ESP 2|250">ESP 2 (250 puntos)</option>
          <option value="ESP 3|500">ESP 3 (500 puntos)</option>
        </select>

        <button type="submit" id="enviarBtn">Enviar Preinscripción</button>
      </form>

      <div id="codigoGenerado">
        <i class="lucide lucide-badge-check ok-icon"></i>
        <h3>¡Preinscripción exitosa!</h3>
        <p>Tu código asignado es:</p>
        <div id="codigo"></div>
        <div class="muted">Guárdalo y compártelo con tu patrocinador.</div>
      </div>
    </div>
  </main>

  <footer>
    &copy; 2025 Red de Acción Masiva. Todos los derechos reservados.
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/lucide@0.349.0/dist/umd/lucide.min.js"></script>
  <script>
    window.addEventListener("DOMContentLoaded",()=>{ lucide.createIcons(); });

    // ⬅️ Reemplaza por tu URL /exec más reciente (Web App publicado como "Anyone")
    const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzdhLfZxyzLJRsNaQHo4HAL0S5EqY3iyIEBA2LM2Y4__t6usmbw9jqvfQMScADjysk/exec";

    let enviando = false;

    const $ = id => document.getElementById(id);
    function normalizarNombre(s){ return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim(); }
    function limpiarTelefono(s){ return (s||"").replace(/\D/g,"").trim(); }
    function normalizarPatrocinador(s){ return (s||"").toUpperCase().trim(); }
    function mostrarError(msg){ $("msgError").textContent = msg; window.scrollTo({top:0,behavior:'smooth'}); }

    // Valida en servidor y confirma que el backend devuelve JSON
    async function validarServidor(nombreNorm, telefonoNum, patrocinadorCode){
      const params = new URLSearchParams({ action:"validate", nombre:nombreNorm, telefono:telefonoNum, patrocinador:patrocinadorCode });
      const res = await fetch(`${APP_SCRIPT_URL}?${params.toString()}`, { method:"GET" });

      const ctype = res.headers.get("content-type") || "";
      if (!res.ok || !ctype.includes("application/json")) {
        throw new Error("VALIDATE_NOT_JSON_OR_403");
      }
      return await res.json(); // {status, existsByPhone, existsByName, sponsorDirectsCount}
    }

    $("preForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      if (enviando) return;

      $("msgError").textContent = "";

      const nombreRaw   = $("nombre").value;
      const telefonoRaw = $("telefono").value;
      const patRaw      = $("patrocinador").value;
      const pais        = $("pais").value;
      const paqueteRaw  = $("paquete").value;

      const nombreNorm   = normalizarNombre(nombreRaw);
      const telefonoNum  = limpiarTelefono(telefonoRaw);
      const patrocinador = normalizarPatrocinador(patRaw);

      if(!nombreNorm || !telefonoNum || !patrocinador || !pais || !paqueteRaw) return mostrarError("Por favor, completa todos los campos.");
      if(!/^[0-9]{7,15}$/.test(telefonoNum)) return mostrarError("El teléfono debe tener entre 7 y 15 dígitos, sin espacios ni signos.");
      if(!/^RM-\d{4}$/i.test(patrocinador))  return mostrarError("Código de patrocinador inválido. Usa el formato RM-1234.");

      const btn = $("enviarBtn");

      try{
        enviando = true;
        btn.disabled = true;
        btn.innerText = "Validando...";

        const v = await validarServidor(nombreNorm, telefonoNum, patrocinador);

        if (v.existsByPhone || v.existsByName) {
          const causa = v.existsByPhone ? "teléfono" : "nombre";
          throw new Error(`Ya existe una preinscripción con ese ${causa}.`);
        }
        if (typeof v.sponsorDirectsCount === "number" && v.sponsorDirectsCount >= 2) {
          throw new Error("El patrocinador indicado ya tiene 2 directos asignados. Solicita un nuevo código.");
        }

        // Envío
        btn.innerText = "Enviando...";
        const [paquete, puntos] = paqueteRaw.split("|");
        const codigoNuevo = "RM-" + Math.floor(1000 + Math.random() * 9000);

        const payload = {
          action:"create",
          nombre:nombreRaw.trim(),
          nombre_norm:nombreNorm,
          telefono:telefonoNum,
          patrocinador,
          pais,
          paquete,
          puntos,
          codigoAsignado:codigoNuevo,
          ts:new Date().toISOString()
        };

        await fetch(APP_SCRIPT_URL, {
          method:"POST",
          mode:"no-cors",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify(payload)
        });

        // Éxito UI
        $("preForm").style.display = "none";
        $("codigoGenerado").style.display = "block";
        $("codigo").textContent = codigoNuevo;
        btn.innerText = "Enviar Preinscripción";

      } catch(err){
        console.error(err);
        if (String(err.message) === "VALIDATE_NOT_JSON_OR_403") {
          mostrarError("No se pudo validar tu preinscripción: usa el URL /exec más reciente del Web App y publícalo como 'Anyone'.");
        } else {
          mostrarError(err.message || "No se pudo validar/enviar tu preinscripción. Inténtalo de nuevo en unos minutos.");
        }
        $("enviarBtn").disabled = false;
        $("enviarBtn").innerText = "Enviar Preinscripción";
        enviando = false;
      }
    });
  </script>
</body>
</html>







