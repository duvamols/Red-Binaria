<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ruleta Baby Shower (Global)</title>
  <style>
    :root{--bg:#0b1220;--border:rgba(255,255,255,.10);--shadow:0 18px 50px rgba(0,0,0,.35);
      --text:#eaf0ff;--muted:#9fb0d0;--ok:#34d399;--danger:#ff6b6b;--accent:#6ee7ff;--accent2:#a78bfa;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--text);padding:16px;display:flex;justify-content:center}
    .card{width:min(720px,100%);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));padding:14px}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:0 0 10px;color:var(--muted);font-size:13px;line-height:1.35}
    label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
    input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(0,0,0,.25);color:var(--text)}
    .btn{border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800}
    .btn.primary{background:linear-gradient(90deg, rgba(110,231,255,.22), rgba(167,139,250,.22));border-color:rgba(110,231,255,.25)}
    .btn.ok{background:rgba(52,211,153,.18);border-color:rgba(52,211,153,.28)}
    .btn.danger{background:rgba(255,107,107,.16);border-color:rgba(255,107,107,.25)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .box{margin-top:12px;border-radius:14px;border:1px solid var(--border);background:rgba(0,0,0,.25);padding:12px}
    .big{font-size:18px;font-weight:900}
    .hint{margin-top:8px;font-size:12px;color:var(--muted)}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.06);margin-right:6px}
    .tag.ok{border-color:rgba(52,211,153,.28);background:rgba(52,211,153,.14);color:#bff7df}
    .tag.bad{border-color:rgba(255,107,107,.30);background:rgba(255,107,107,.14);color:#ffd2d2}
  </style>
</head>
<body>
  <div class="card">
    <h1>üéÅ Ruleta de regalos (Baby Shower)</h1>
    <p>
      Escribe tu nombre y presiona <b>Girar</b>. Si no te gusta, presiona <b>Cancelar</b> y gira otra vez.
      Si presionas <b>Escoger/Aceptar</b>, el regalo se <b>bloquea</b> para todos.
    </p>

    <label>Tu nombre</label>
    <input id="name" placeholder="Escribe tu nombre" />

    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnSpin">Girar</button>
      <button class="btn danger" id="btnCancel" disabled>Cancelar</button>
      <button class="btn ok" id="btnAccept" disabled>Escoger / Aceptar</button>
    </div>

    <div class="box">
      <div class="big" id="gift">‚Äî</div>
      <div style="margin-top:8px" id="meta"></div>
      <div class="hint" id="hint">Cargando estado...</div>
    </div>

    <div class="hint" id="counts"></div>
  </div>

<script>
  // 1) Pega tu URL del Web App de Apps Script aqu√≠:
  const API_URL = "https://script.google.com/macros/s/AKfycbzBu_H8wIgQCAkUmGRtKQQa83juz0m-xPhUa_9AUbVXWi4pNNA86yGenVPncSLYnOCBTg/exec";

  const $ = (id)=>document.getElementById(id);
  const elGift = $("gift");
  const elMeta = $("meta");
  const elHint = $("hint");
  const elCounts = $("counts");
  const btnSpin = $("btnSpin");
  const btnCancel = $("btnCancel");
  const btnAccept = $("btnAccept");

  let lastPick = null; // {id, regalo, estado, asignado_a}

  function setHint(msg, kind){
    elHint.textContent = msg;
    elHint.style.color = kind==="bad" ? "rgba(255,210,210,.95)"
                     : kind==="ok" ? "rgba(191,247,223,.95)"
                     : "rgba(159,176,208,.95)";
  }

  async function apiGetStatus(){
    const res = await fetch(API_URL + "?action=status");
    return res.json();
  }

  async function apiSpin(name){
    const res = await fetch(API_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ action:"spin", name })
    });
    return res.json();
  }

  async function apiAccept(name, id){
    const res = await fetch(API_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ action:"accept", name, id })
    });
    return res.json();
  }

  function renderPick(pick){
    lastPick = pick;
    elGift.textContent = pick.regalo;

    elMeta.innerHTML = "";
    const statusTag = document.createElement("span");
    statusTag.className = "tag " + (pick.estado === "LIBRE" ? "ok" : "bad");
    statusTag.textContent = pick.estado === "LIBRE" ? "‚úÖ Libre" : "üîí Tomado";
    elMeta.appendChild(statusTag);

    if(pick.estado !== "LIBRE"){
      const who = document.createElement("span");
      who.className = "tag bad";
      who.textContent = "Por: " + (pick.asignado_a || "‚Äî");
      elMeta.appendChild(who);
    } else {
      const idTag = document.createElement("span");
      idTag.className = "tag";
      idTag.textContent = "#" + pick.id;
      elMeta.appendChild(idTag);
    }

    btnCancel.disabled = false;
    btnAccept.disabled = (pick.estado !== "LIBRE");
  }

  function resetDecisionUI(){
    lastPick = null;
    elGift.textContent = "‚Äî";
    elMeta.innerHTML = "";
    btnCancel.disabled = true;
    btnAccept.disabled = true;
  }

  async function refreshCounts(){
    try{
      const st = await apiGetStatus();
      if(!st.ok) throw new Error(st.error || "No ok");
      elCounts.textContent = `üéÅ Total: ${st.total} | ‚úÖ Disponibles: ${st.libres} | üîí Tomados: ${st.tomados}`;
      setHint("Listo. Ahora gira la ruleta.", "neutral");
    }catch(e){
      setHint("No se pudo cargar el estado. Revisa la URL del API.", "bad");
    }
  }

  btnSpin.addEventListener("click", async ()=>{
    const name = $("name").value.trim();
    if(!name){ setHint("Escribe tu nombre antes de girar.", "bad"); $("name").focus(); return; }

    btnSpin.disabled = true;
    resetDecisionUI();
    setHint("Sorteando...", "neutral");

    try{
      const r = await apiSpin(name);
      if(!r.ok) throw new Error(r.error || "Error en spin");
      renderPick(r.pick);
      if(r.pick.estado !== "LIBRE"){
        setHint("Te sali√≥ uno tomado. Pulsa Cancelar y gira otra vez.", "bad");
      } else {
        setHint("Si te gusta, pulsa Aceptar. Si no, Cancelar y vuelves a girar.", "ok");
      }
      await refreshCounts();
    }catch(e){
      setHint("Error: " + e.message, "bad");
    }finally{
      btnSpin.disabled = false;
    }
  });

  btnCancel.addEventListener("click", ()=>{
    resetDecisionUI();
    setHint("Cancelado. Puedes girar otra vez.", "neutral");
  });

  btnAccept.addEventListener("click", async ()=>{
    const name = $("name").value.trim();
    if(!name){ setHint("Escribe tu nombre.", "bad"); return; }
    if(!lastPick){ setHint("Primero gira.", "bad"); return; }
    if(lastPick.estado !== "LIBRE"){ setHint("Ese regalo ya est√° tomado. Gira otra vez.", "bad"); return; }

    btnAccept.disabled = true;
    btnSpin.disabled = true;
    btnCancel.disabled = true;
    setHint("Bloqueando regalo...", "neutral");

    try{
      const r = await apiAccept(name, lastPick.id);
      if(!r.ok){
        // Si alguien alcanz√≥ a aceptarlo antes
        setHint(r.error || "No se pudo bloquear. Vuelve a girar.", "bad");
        resetDecisionUI();
        await refreshCounts();
        return;
      }
      setHint("‚úÖ Listo: tu regalo qued√≥ bloqueado para todos.", "ok");
      await refreshCounts();
    }catch(e){
      setHint("Error: " + e.message, "bad");
    }finally{
      btnSpin.disabled = false;
      btnCancel.disabled = true; // ya acept√≥: no cancela
    }
  });

  // init
  refreshCounts();
</script>
</body>
</html>





