<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ruleta de regalos (Baby Shower)</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#121b2f;
      --muted:#9fb0d0;
      --text:#eaf0ff;
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --danger:#ff6b6b;
      --ok:#34d399;
      --border:rgba(255,255,255,.10);
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(110,231,255,.18), transparent 55%),
        radial-gradient(900px 700px at 90% 20%, rgba(167,139,250,.16), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px;
    }
    .wrap{
      width:min(980px,100%);
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media(max-width:900px){ .wrap{grid-template-columns:1fr;} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    h1{margin:0 0 8px;font-size:20px}
    .sub{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.35}
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:12px}
    input{
      width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      font-weight:800;
      transition: transform .05s ease, opacity .15s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background: linear-gradient(90deg, rgba(110,231,255,.22), rgba(167,139,250,.22));
      border-color:rgba(110,231,255,.25);
    }
    .btn.ok{
      background: rgba(52,211,153,.18);
      border-color:rgba(52,211,153,.28);
    }
    .btn.danger{
      background: rgba(255,107,107,.16);
      border-color:rgba(255,107,107,.25);
    }
    .btn:disabled{opacity:.45; cursor:not-allowed}

    /* Ruleta */
    .wheelWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .pointer{
      width:0;height:0;
      border-left:18px solid transparent;
      border-right:18px solid transparent;
      border-bottom:26px solid var(--accent);
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.45));
      margin-bottom:-4px;
    }
    canvas{
      width:min(520px, 100%);
      height:auto;
      max-width: 520px;
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border:1px solid var(--border);
    }

    .box{
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      padding:12px;
      margin-top:10px;
    }
    .big{font-size:16px;font-weight:900;line-height:1.25}
    .hint{margin-top:8px;font-size:12px;color:var(--muted)}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.06);margin-right:6px}
    .tag.ok{border-color:rgba(52,211,153,.28);background:rgba(52,211,153,.14);color:#bff7df}
    .tag.bad{border-color:rgba(255,107,107,.30);background:rgba(255,107,107,.14);color:#ffd2d2}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--muted);font-size:12px;white-space:nowrap;
    }
    .footerRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:10px}

    /* ===== Modal final (beb√© ni√±o) ===== */
    .finalModal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      background: radial-gradient(900px 600px at 30% 20%, rgba(110,231,255,.18), transparent 60%),
                  rgba(0,0,0,.65);
      backdrop-filter: blur(10px);
      z-index:9999;
    }
    .finalModal.show{ display:flex; }

    .finalCard{
      width:min(560px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 22px 70px rgba(0,0,0,.45);
      overflow:hidden;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(110,231,255,.25), transparent 55%),
        radial-gradient(700px 500px at 90% 10%, rgba(167,139,250,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      padding:14px;
    }

    /* grande y c√≥modo en celular */
    @media (max-width: 520px){
      .finalCard{
        width:100%;
        max-height: 78vh;
        overflow:auto;
        border-radius:20px;
      }
    }

    .finalHead{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .finalLeft{
      display:flex;
      gap:12px;
      align-items:center;
      min-width:0;
    }
    .babyBadge{
      width:44px;height:44px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(110,231,255,.18);
      border:1px solid rgba(110,231,255,.22);
      font-size:22px;
      flex:0 0 auto;
    }
    .finalTitle{
      font-weight:950;
      font-size:16px;
      letter-spacing:.2px;
    }
    .finalSub{
      font-size:12px;
      color:rgba(234,240,255,.85);
      margin-top:2px;
      word-break:break-word;
    }
    .finalClose{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius:12px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      flex:0 0 auto;
    }

    .giftBlock{
      margin-top:12px;
      border-radius:18px;
      border:1px solid rgba(52,211,153,.25);
      background: rgba(52,211,153,.10);
      padding:12px;
    }
    .giftLabel{
      color: rgba(191,247,223,.95);
      font-size:12px;
      font-weight:900;
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.3px;
    }
    .giftName{
      font-size:18px;
      font-weight:950;
      line-height:1.25;
    }

    .thanksBlock{
      margin-top:12px;
      border-radius:18px;
      border:1px solid rgba(110,231,255,.18);
      background: rgba(0,0,0,.18);
      padding:12px;
    }
    .thanksTitle{
      font-weight:950;
      font-size:14px;
      margin-bottom:6px;
    }
    .thanksText{
      color: var(--muted);
      font-size:12px;
      margin-bottom:10px;
      line-height:1.35;
    }
    .eventInfo{
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.16);
      padding:10px;
      background: rgba(255,255,255,.04);
    }
    .eventRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      font-size:12px;
      color: rgba(234,240,255,.92);
      margin:6px 0;
      line-height:1.35;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(110,231,255,.85);
      margin-top:4px;
      flex:0 0 auto;
    }

    .finalBtn{
      width:100%;
      margin-top:12px;
      font-size:14px;
      padding:12px 12px;
      border-radius:14px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- IZQ: Ruleta -->
    <div class="card">
      <h1>üéÅ Ruleta de regalos (Baby Shower)</h1>
      <p class="sub">
        Escribe tu nombre y presiona <b>Girar</b>. Si no te gusta, presiona <b>No escoger este regalo</b> y vuelve a girar.
        Si presionas <b>Escoger regalo</b>, el regalo se bloquea para todos.
      </p>

      <label>Tu nombre</label>
      <input id="name" placeholder="Escribe tu nombre" />

      <div class="wheelWrap" style="margin-top:12px;">
        <div class="pointer" aria-hidden="true"></div>
        <canvas id="wheel" width="700" height="700"></canvas>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnSpin">Girar</button>
        <button class="btn danger" id="btnNoPick" disabled>No escoger este regalo</button>
        <button class="btn ok" id="btnPick" disabled>Escoger regalo</button>
      </div>

      <div class="box">
        <div class="big" id="gift">‚Äî</div>
        <div style="margin-top:8px" id="meta"></div>
        <div class="hint" id="hint">Cargando regalos...</div>
      </div>

      <div class="footerRow">
        <span class="pill">üéÅ Total: <span id="tTotal">0</span></span>
        <span class="pill">‚úÖ Disponibles: <span id="tFree">0</span></span>
        <span class="pill">üîí Tomados: <span id="tUsed">0</span></span>
      </div>
    </div>

    <!-- DER: Info / ayuda -->
    <div class="card">
      <h1>‚ÑπÔ∏è ¬øC√≥mo funciona?</h1>
      <p class="sub">
        1) Escribes tu nombre<br>
        2) Giras la ruleta<br>
        3) Si no te gusta, <b>No escoger este regalo</b> y giras otra vez<br>
        4) Si te gusta, <b>Escoger regalo</b> y queda bloqueado para todos ‚úÖ
      </p>

      <div class="box">
        <div class="big">üß† Regla importante</div>
        <div class="hint">
          Despu√©s de girar, debes elegir uno de los dos botones:
          <b>No escoger este regalo</b> o <b>Escoger regalo</b>.
          Hasta que elijas, no podr√°s volver a girar.
        </div>
      </div>

      <div class="box">
        <div class="big">‚úÖ Confirmaci√≥n final</div>
        <div class="hint">
          Al escoger regalo, se mostrar√° una tarjeta bonita con tu nombre y el regalo asignado,
          y el sistema ya no permitir√° girar nuevamente desde ese dispositivo.
        </div>
      </div>
    </div>

  </div>

  <!-- Modal final -->
  <div class="finalModal" id="finalModal" aria-hidden="true">
    <div class="finalCard">
      <div class="finalHead">
        <div class="finalLeft">
          <div class="babyBadge">üë∂</div>
          <div style="min-width:0;">
            <div class="finalTitle">¬°Regalo confirmado!</div>
            <div class="finalSub" id="finalName">‚Äî</div>
          </div>
        </div>
        <button class="finalClose" id="finalClose">X</button>
      </div>

      <div class="giftBlock">
        <div class="giftLabel">Tu regalo asignado es</div>
        <div class="giftName" id="finalGift">‚Äî</div>
      </div>

      <div class="thanksBlock">
        <div class="thanksTitle">¬°Gracias por aceptar nuestra invitaci√≥n! üíô</div>
        <div class="thanksText">
          Te esperamos con gran ilusi√≥n. Por favor recuerda:
        </div>

        <div class="eventInfo">
          <div class="eventRow"><span class="dot"></span><b>Domingo 22 de febrero</b></div>
          <div class="eventRow"><span class="dot"></span><b>2:00 pm</b></div>
          <div class="eventRow"><span class="dot"></span>Sal√≥n comunal del conjunto <b>Remansos de Funza</b></div>
          <div class="eventRow"><span class="dot"></span><b>Funza, Cundinamarca</b></div>
        </div>
      </div>

      <button class="btn ok finalBtn" id="finalOkBtn">¬°Listo, all√° estar√©! ‚úÖ</button>
    </div>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const API_URL = "https://script.google.com/macros/s/AKfycbxabBPFNJ-jMysCEOvVOUBk6ClP4B4LB2WSxsvuzsvPPoKtk9-ufNwDOMTw6GZLNQvHeA/exec";

  // =========================
  // DOM
  // =========================
  const $ = (id)=>document.getElementById(id);
  const elGift = $("gift");
  const elMeta = $("meta");
  const elHint = $("hint");

  const btnSpin = $("btnSpin");
  const btnNoPick = $("btnNoPick");
  const btnPick = $("btnPick");

  const tTotal = $("tTotal");
  const tFree  = $("tFree");
  const tUsed  = $("tUsed");

  const canvas = $("wheel");
  const ctx = canvas.getContext("2d");

  // Modal final
  const finalModal = $("finalModal");
  const finalClose = $("finalClose");
  const finalOkBtn = $("finalOkBtn");
  const finalNameEl = $("finalName");
  const finalGiftEl = $("finalGift");

  // =========================
  // STATE
  // =========================
  let gifts = []; // {id, regalo, estado, asignado_a}
  let spinning = false;
  let mustDecide = false;
  let lastPick = null;
  let wheelAngle = 0;

  const LS_DONE = "baby_ruleta_done_v1";
  const LS_DONE_NAME = "baby_ruleta_done_name_v1";
  const LS_DONE_GIFT = "baby_ruleta_done_gift_v1";

  // =========================
  // JSONP (sin CORS)
  // =========================
  function jsonpCall(params){
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const url = new URL(API_URL);
      Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
      url.searchParams.set("callback", cbName);

      const s = document.createElement("script");
      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("Timeout JSONP"));
      }, 12000);

      window[cbName] = (data) => {
        cleanup();
        resolve(data);
      };

      function cleanup(){
        clearTimeout(timeout);
        delete window[cbName];
        s.remove();
      }

      s.onerror = () => {
        cleanup();
        reject(new Error("JSONP error"));
      };

      s.src = url.toString();
      document.body.appendChild(s);
    });
  }

  async function apiStatus(){ return jsonpCall({ action:"status" }); }
  async function apiSpin(name){ return jsonpCall({ action:"spin", name }); }
  async function apiAccept(name, id){ return jsonpCall({ action:"accept", name, id:String(id) }); }

  // =========================
  // UI helpers
  // =========================
  function setHint(msg, kind){
    elHint.textContent = msg;
    elHint.style.color =
      kind==="bad" ? "rgba(255,210,210,.95)" :
      kind==="ok"  ? "rgba(191,247,223,.95)" :
      "rgba(159,176,208,.95)";
  }

  function setMeta(pick){
    elMeta.innerHTML = "";
    if(!pick) return;

    const st = document.createElement("span");
    st.className = "tag " + (pick.estado === "LIBRE" ? "ok" : "bad");
    st.textContent = pick.estado === "LIBRE" ? "‚úÖ Libre" : "üîí Tomado";
    elMeta.appendChild(st);

    const idTag = document.createElement("span");
    idTag.className = "tag";
    idTag.textContent = "#" + pick.id;
    elMeta.appendChild(idTag);

    if(pick.estado !== "LIBRE"){
      const who = document.createElement("span");
      who.className = "tag bad";
      who.textContent = "Por: " + (pick.asignado_a || "‚Äî");
      elMeta.appendChild(who);
    }
  }

  function resetPick(){
    lastPick = null;
    elGift.textContent = "‚Äî";
    elMeta.innerHTML = "";
  }

  function setCounts(total, libres, tomados){
    tTotal.textContent = total;
    tFree.textContent = libres;
    tUsed.textContent = tomados;
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  // =========================
  // Modal final
  // =========================
  function openFinalModal(name, gift){
    finalNameEl.textContent = name;
    finalGiftEl.textContent = gift;
    finalModal.classList.add("show");
    finalModal.setAttribute("aria-hidden", "false");
  }
  function closeFinalModal(){
    finalModal.classList.remove("show");
    finalModal.setAttribute("aria-hidden", "true");
  }
  finalClose.addEventListener("click", closeFinalModal);
  finalOkBtn.addEventListener("click", closeFinalModal);
  finalModal.addEventListener("click", (e)=>{
    if(e.target === finalModal) closeFinalModal();
  });

  // =========================
  // Wheel drawing
  // =========================
  function drawWheel(){
    const W = canvas.width, H = canvas.height;
    const cx = W/2, cy = H/2;
    const r = Math.min(cx,cy) - 18;

    ctx.clearRect(0,0,W,H);

    ctx.save();
    ctx.translate(cx,cy);

    // sombra base
    ctx.beginPath();
    ctx.arc(0,0,r+6,0,Math.PI*2);
    ctx.fillStyle = "rgba(0,0,0,.20)";
    ctx.fill();

    const n = Math.max(gifts.length, 1);
    const slice = (Math.PI*2) / n;

    ctx.rotate(wheelAngle);

    for(let i=0;i<n;i++){
      const g = gifts[i];
      const a0 = i*slice;
      const a1 = a0 + slice;

      const alt = i%2===0;
      const base = alt ? "rgba(110,231,255,.22)" : "rgba(167,139,250,.20)";
      const fill = (g && g.estado === "TOMADO") ? "rgba(255,107,107,.18)" : base;

      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.arc(0,0,r,a0,a1);
      ctx.closePath();
      ctx.fillStyle = fill;
      ctx.fill();

      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 2;
      ctx.stroke();

      // texto
      const label = g ? g.regalo : "Cargando...";
      const mid = (a0+a1)/2;

      ctx.save();
      ctx.rotate(mid);
      ctx.translate(r*0.62,0);
      ctx.rotate(Math.PI/2);

      ctx.fillStyle = (g && g.estado === "TOMADO") ? "rgba(255,210,210,.92)" : "rgba(234,240,255,.92)";
      ctx.font = "800 18px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      const short = label.length <= 18 ? label : label.slice(0,17) + "‚Ä¶";
      ctx.fillText(short, 0, 0);

      if(g && g.estado === "TOMADO"){
        ctx.font = "900 12px system-ui, -apple-system, Segoe UI, Roboto";
        ctx.fillText("üîí", 0, 22);
      }
      ctx.restore();
    }

    // centro
    ctx.beginPath();
    ctx.arc(0,0,70,0,Math.PI*2);
    ctx.fillStyle = "rgba(0,0,0,.30)";
    ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,.12)";
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.fillStyle = "rgba(234,240,255,.95)";
    ctx.font = "900 18px system-ui, -apple-system, Segoe UI, Roboto";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("BABY", 0, -6);
    ctx.font = "700 12px system-ui, -apple-system, Segoe UI, Roboto";
    ctx.fillStyle = "rgba(159,176,208,.95)";
    ctx.fillText("Shower", 0, 16);

    ctx.restore();
  }

  // puntero arriba => -90¬∞
  function getIndexFromAngle(angle){
    const n = gifts.length;
    if(!n) return -1;
    const pointerAngle = (-Math.PI/2 - angle) % (Math.PI*2);
    const norm = (pointerAngle + Math.PI*2) % (Math.PI*2);
    const slice = (Math.PI*2) / n;
    let idx = Math.floor(norm / slice);
    idx = (idx + n) % n;
    return idx;
  }

  // =========================
  // Flow control
  // =========================
  function lockAfterAccepted(name, gift){
    localStorage.setItem(LS_DONE, "1");
    localStorage.setItem(LS_DONE_NAME, name);
    localStorage.setItem(LS_DONE_GIFT, gift);
  }

  function alreadyAccepted(){
    return localStorage.getItem(LS_DONE) === "1";
  }

  function setButtons(){
    const done = alreadyAccepted();

    if(done){
      btnSpin.disabled = true;
      btnNoPick.disabled = true;
      btnPick.disabled = true;
      return;
    }

    if(spinning){
      btnSpin.disabled = true;
      btnNoPick.disabled = true;
      btnPick.disabled = true;
      return;
    }

    btnSpin.disabled = mustDecide;
    btnNoPick.disabled = !mustDecide;
    btnPick.disabled = !(mustDecide && lastPick && lastPick.estado === "LIBRE");
  }

  // =========================
  // SONIDO RULETA (ticks + ding)
  // =========================
  let audioCtx = null;
  let tickTimer = null;
  let lastTickIndex = -1;

  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === "suspended"){
      audioCtx.resume();
    }
  }

  function playTick(){
    if(!audioCtx) return;
    const t = audioCtx.currentTime;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "square";
    osc.frequency.setValueAtTime(900, t);

    gain.gain.setValueAtTime(0.0001, t);
    gain.gain.exponentialRampToValueAtTime(0.16, t + 0.004);
    gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.03);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(t);
    osc.stop(t + 0.04);
  }

  function playDing(){
    if(!audioCtx) return;
    const t = audioCtx.currentTime;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "sine";
    osc.frequency.setValueAtTime(880, t);
    osc.frequency.exponentialRampToValueAtTime(1320, t + 0.12);

    gain.gain.setValueAtTime(0.0001, t);
    gain.gain.exponentialRampToValueAtTime(0.20, t + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.22);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(t);
    osc.stop(t + 0.25);
  }

  function startTicking(){
    lastTickIndex = -1;
    stopTicking();
    tickTimer = setInterval(() => {
      if(!spinning) return;
      const idx = getIndexFromAngle(wheelAngle);
      if(idx !== -1 && idx !== lastTickIndex){
        lastTickIndex = idx;
        playTick();
      }
    }, 25);
  }

  function stopTicking(){
    if(tickTimer){
      clearInterval(tickTimer);
      tickTimer = null;
    }
  }

  // =========================
  // Load status (gifts + counts)
  // =========================
  async function refreshAll(){
    try{
      const st = await apiStatus();
      if(!st.ok) throw new Error(st.error || "Status error");
      gifts = st.regalos || [];
      setCounts(st.total||0, st.libres||0, st.tomados||0);
      drawWheel();

      if(alreadyAccepted()){
        const n = localStorage.getItem(LS_DONE_NAME) || "‚Äî";
        const g = localStorage.getItem(LS_DONE_GIFT) || "‚Äî";
        setHint("Ya escogiste un regalo. ¬°Gracias por participar!", "ok");
        elGift.textContent = g;
        setMeta({id:"‚Äî", estado:"TOMADO", asignado_a:n});
        openFinalModal(n, g);
      } else {
        setHint("Listo. Escribe tu nombre y gira la ruleta.", "neutral");
      }

      setButtons();
    }catch(e){
      setHint("Error cargando datos: " + e.message, "bad");
      gifts = [];
      setCounts(0,0,0);
      drawWheel();
      setButtons();
    }
  }

  // =========================
  // Spin animation (visual)
  // =========================
  function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  btnSpin.addEventListener("click", async ()=>{
    const name = $("name").value.trim();
    if(!name){ setHint("Escribe tu nombre antes de girar.", "bad"); $("name").focus(); return; }
    if(alreadyAccepted()){ setHint("Ya escogiste un regalo. ¬°Gracias!", "ok"); openFinalModal(localStorage.getItem(LS_DONE_NAME)||name, localStorage.getItem(LS_DONE_GIFT)||"‚Äî"); return; }
    if(mustDecide){ setHint("Debes elegir: No escoger este regalo / Escoger regalo.", "bad"); return; }
    if(spinning) return;

    // activar audio por interacci√≥n
    ensureAudio();
    startTicking();

    spinning = true;
    mustDecide = false;
    resetPick();
    setHint("Sorteando y girando la ruleta...", "neutral");
    setButtons();

    try{
      const r = await apiSpin(name);
      if(!r.ok) throw new Error(r.error || "No se pudo sortear");
      const pick = r.pick;

      let targetIndex = gifts.findIndex(g => Number(g.id) === Number(pick.id));
      if(targetIndex === -1){
        await refreshAll();
        targetIndex = gifts.findIndex(g => Number(g.id) === Number(pick.id));
      }
      if(targetIndex === -1) throw new Error("No se encontr√≥ el regalo en la ruleta (id).");

      const n = gifts.length;
      const slice = (Math.PI*2)/n;

      const centerAngleForIndex = (targetIndex + 0.5) * slice;
      const desired = -Math.PI/2 - centerAngleForIndex;

      const extraSpins = randInt(6, 10);
      const start = wheelAngle;

      let endBase = desired;
      while(endBase < start) endBase += Math.PI*2;
      const target = endBase + extraSpins * Math.PI*2;

      const duration = randInt(2600, 3800);
      const t0 = performance.now();

      function frame(now){
        const t = Math.min(1, (now - t0) / duration);
        const e = easeOutCubic(t);
        wheelAngle = start + (target - start) * e;
        drawWheel();

        if(t < 1){
          requestAnimationFrame(frame);
        }else{
          spinning = false;
          stopTicking();
          playDing();

          lastPick = { ...pick, estado:"LIBRE" };
          elGift.textContent = pick.regalo;
          setMeta(lastPick);

          mustDecide = true;
          setHint('Ahora decide: "No escoger este regalo" o "Escoger regalo".', "ok");
          setButtons();
        }
      }
      requestAnimationFrame(frame);

    }catch(e){
      spinning = false;
      mustDecide = false;
      stopTicking();
      setHint("Error: " + e.message, "bad");
      setButtons();
    }
  });

  btnNoPick.addEventListener("click", ()=>{
    if(alreadyAccepted()) return;
    if(!mustDecide) return;

    resetPick();
    mustDecide = false;
    setHint("Perfecto. Puedes girar otra vez.", "neutral");
    setButtons();
  });

  btnPick.addEventListener("click", async ()=>{
    const name = $("name").value.trim();
    if(!name){ setHint("Escribe tu nombre.", "bad"); return; }
    if(alreadyAccepted()){ openFinalModal(localStorage.getItem(LS_DONE_NAME)||name, localStorage.getItem(LS_DONE_GIFT)||"‚Äî"); return; }
    if(!mustDecide || !lastPick){ setHint("Primero gira y luego decide.", "bad"); return; }
    if(lastPick.estado !== "LIBRE"){
      setHint("Ese regalo ya est√° tomado. Elige 'No escoger...' y vuelve a girar.", "bad");
      return;
    }

    spinning = true;
    setHint("Bloqueando tu regalo...", "neutral");
    setButtons();

    try{
      const r = await apiAccept(name, lastPick.id);
      if(!r.ok){
        spinning = false;
        mustDecide = false;
        resetPick();
        await refreshAll();
        setHint((r.error || "No se pudo bloquear") + ". Vuelve a girar.", "bad");
        return;
      }

      const giftName = lastPick.regalo;
      lockAfterAccepted(name, giftName);

      mustDecide = false;
      spinning = false;

      await refreshAll();

      setHint("‚úÖ Tu regalo qued√≥ confirmado. ¬°Gracias!", "ok");
      setButtons();

      // Modal bonito (centrado)
      openFinalModal(name, giftName);

    }catch(e){
      spinning = false;
      setHint("Error: " + e.message, "bad");
      setButtons();
    }
  });

  // init
  refreshAll();
</script>
</body>
</html>

